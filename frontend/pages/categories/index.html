<!DOCTYPE html>
<html lang="es-AR" translate="no" data-bs-theme="dark">
<head>
  <base href="/" target="_blank">
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="google" content="notranslate">
  <link rel="shortcut icon" href="../static/img/favicon.svg" />
  <title>Categorías</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="csrf-token" content="<%= it.csrfToken %>">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.css" />

  <link rel="stylesheet" href="../static/css/styles.css">
  <link rel="stylesheet" href="../static/css/bootstrap.css">
  <link rel="stylesheet" href="../static/css/sidebar.css">
  <link rel="stylesheet" href="../static/css/header.css">

  <script src="../static/js/dark_light.js"></script>
  <script src="//code.jquery.com/jquery-2.1.0.min.js"></script>

  <style>
    :root{
      --bg1:#070A10;
      --bg2:#0B1020;

      --accent:#8B5CF6;
      --accent2:#22D3EE;
      --accent3:#A78BFA;

      --line: rgba(167,139,250,.18);

      --text:#EAF0FF;
      --muted:#AAB3D6;

      --radius:18px;

      --shadow: 0 18px 55px rgba(0,0,0,.65);
      --ring: 0 0 0 3px rgba(139,92,246,.18);
      --softGlow: 0 0 0 1px rgba(167,139,250,.12), 0 12px 28px rgba(0,0,0,.55);
      --softGlow2: 0 0 0 1px rgba(34,211,238,.12), 0 18px 40px rgba(0,0,0,.62);
    }

    html, body{ height:100%; }
    body,
    body[data-bs-theme="light"],
    body[data-bs-theme="dark"]{
      min-height:100vh !important;
      color:var(--text) !important;
      background:
        radial-gradient(950px 520px at 18% 12%, rgba(139,92,246,.18), transparent 62%),
        radial-gradient(900px 520px at 82% 14%, rgba(34,211,238,.14), transparent 60%),
        radial-gradient(900px 620px at 50% 92%, rgba(167,139,250,.10), transparent 62%),
        linear-gradient(135deg, var(--bg1), var(--bg2)) !important;
      background-attachment: fixed !important;
      overflow-x:hidden;
    }
    .container-fluid, main.d-flex{ background: transparent !important; }

    main.d-flex{ min-height:100vh; justify-content:center; }
    .container-fluid{ max-width: 1250px; width: 100%; }

    .content{
      display:flex; justify-content:center; align-items:center;
      min-height: calc(100vh - 80px);
      padding: 16px;
    }

    .content > .card{
      width:100%;
      max-width:1120px;
      max-height: calc(100vh - 120px);
      border-radius: calc(var(--radius) + 6px);
      background: linear-gradient(180deg, rgba(14,20,36,.92), rgba(11,16,32,.88));
      border: 1px solid rgba(167,139,250,.18) !important;
      box-shadow: var(--shadow), 0 0 0 1px rgba(34,211,238,.05);
      backdrop-filter: blur(10px);
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }
    .card-body{ padding: 18px; }

    .text-gray-800{
      color: var(--text) !important;
      letter-spacing: .14em;
      text-transform: uppercase;
      font-weight: 900;
    }

    .mini-label{
      display:block;
      font-size:.75rem;
      letter-spacing:.14em;
      text-transform: uppercase;
      color: rgba(170,179,214,.92);
      margin: 0 0 6px;
    }

    .form-select{
      background: rgba(7,10,18,.86) !important;
      border: 1px solid rgba(167,139,250,.18) !important;
      color: var(--text) !important;
      border-radius: 14px !important;
      box-shadow: inset 0 0 0 1px rgba(34,211,238,.04);
    }
    .form-select:focus{
      border-color: rgba(34,211,238,.30) !important;
      box-shadow: var(--ring) !important;
    }

    .btn{
      border-radius: 14px !important;
      border: 1px solid rgba(167,139,250,.16) !important;
      color: var(--text) !important;
      background: rgba(7,10,18,.70) !important;
      box-shadow: 0 0 0 1px rgba(34,211,238,.04), 0 10px 18px rgba(0,0,0,.40);
      transition: transform .08s ease, box-shadow .2s ease, filter .2s ease;
      font-weight: 800;
      letter-spacing:.06em;
      text-transform: uppercase;
    }
    .btn:hover{
      transform: translateY(-1px);
      box-shadow: var(--softGlow2);
      filter: brightness(1.03);
    }

    /* ✅ Wrapper */
    .table-responsive{
      border-radius: 18px;
      border: 1px solid rgba(167,139,250,.16);
      background: rgba(0,0,0,.55);
      box-shadow: inset 0 0 0 1px rgba(34,211,238,.04);
      overflow: hidden;
      padding: 10px;
    }

    /* ✅ FIX CRÍTICO: hook delete existe pero no se ve */
    .__btn__delete.dt-hidden-hook{ display:none !important; }

    /* ===========================
       ✅ CARDS (SIN ROMPER DOM)
       - Muestra: Nombre + Acciones + Color
       - Oculta: ID/Orden/Estado (pero siguen en el DOM)
       =========================== */
    table.table.cat-cards{ width:100%; margin:0; }
    table.table.cat-cards thead{ display:none !important; }

    table.table.cat-cards tbody{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    table.table.cat-cards tbody tr{
      display:grid !important;
      grid-template-columns: 1fr auto;
      grid-template-rows: auto auto;
      grid-template-areas:
        "name actions"
        "color actions";
      gap: 10px 12px;

      border-radius: 16px;
      background: rgba(0,0,0,.86);
      border: 1px solid rgba(167,139,250,.18);
      box-shadow: 0 0 0 1px rgba(34,211,238,.05), 0 16px 28px rgba(0,0,0,.55);
      overflow: hidden;
      padding: 0;
    }

    /* Nombre (TD 2) */
    table.table.cat-cards tbody tr td:nth-child(2),
    table.table.cat-cards tbody tr th:nth-child(2){
      grid-area: name;
      padding: 10px 12px !important;
      border:0 !important;
      min-width:0;
      background:
        radial-gradient(260px 60px at 20% 30%, rgba(34,211,238,.10), transparent 62%),
        radial-gradient(320px 60px at 70% 30%, rgba(139,92,246,.14), transparent 65%),
        rgba(0,0,0,.55);
      border-bottom: 1px solid rgba(167,139,250,.12) !important;

      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .dt-cat-name{
      font-weight: 950;
      letter-spacing:.02em;
      font-size: .98rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 70%;
      color: var(--text);
    }

    /* Color (TD 4) */
    table.table.cat-cards tbody tr td:nth-child(4),
    table.table.cat-cards tbody tr th:nth-child(4){
      grid-area: color;
      border:0 !important;
      background: rgba(0,0,0,.55);
      padding: 12px !important;
      display:flex;
      align-items:center;
      gap: 10px;
      color: rgba(234,240,255,.92);
      font-size: .92rem;
    }

    table.table.cat-cards tbody tr td:nth-child(4)::before,
    table.table.cat-cards tbody tr th:nth-child(4)::before{
      content:"Color:";
      color: rgba(170,179,214,.92);
      font-weight: 900;
      font-size: .82rem;
      letter-spacing: .02em;
      text-transform: uppercase;
    }

    .dt-color-dot{
      width: 16px;
      height: 16px;
      border-radius: 999px;
      border: 1px solid rgba(167,139,250,.22);
      box-shadow: 0 0 0 1px rgba(34,211,238,.05), 0 10px 18px rgba(0,0,0,.35);
      display:inline-block;
    }

    /* Acciones (TD 6) - REAL */
    table.table.cat-cards tbody tr td:nth-child(6),
    table.table.cat-cards tbody tr th:nth-child(6){
      grid-area: actions;
      border:0 !important;
      background: rgba(0,0,0,.55);
      padding: 12px !important;
      display:flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-end;
      justify-content: center;
      min-width: 96px;
    }

    table.table.cat-cards tbody tr td:nth-child(6) .btn,
    table.table.cat-cards tbody tr td:nth-child(6) button,
    table.table.cat-cards tbody tr td:nth-child(6) a,
    table.table.cat-cards tbody tr th:nth-child(6) .btn,
    table.table.cat-cards tbody tr th:nth-child(6) button,
    table.table.cat-cards tbody tr th:nth-child(6) a{
      width: 42px;
      height: 36px;
      display:inline-flex !important;
      align-items:center !important;
      justify-content:center !important;
      padding:0 !important;
      border-radius: 12px !important;
      background: rgba(0,0,0,.72) !important;
      border: 1px solid rgba(167,139,250,.16) !important;
      box-shadow: 0 0 0 1px rgba(34,211,238,.04), 0 10px 18px rgba(0,0,0,.55);
      color: var(--text) !important;
      text-decoration:none !important;
    }
    table.table.cat-cards tbody tr td:nth-child(6) i,
    table.table.cat-cards tbody tr th:nth-child(6) i{
      font-size: 1.02rem;
      color: rgba(34,211,238,.90);
    }

    /* ✅ Ocultar resto (ID=TD1, Orden=TD3, Estado=TD5) pero siguen en DOM */
    table.table.cat-cards tbody tr td:nth-child(1),
    table.table.cat-cards tbody tr td:nth-child(3),
    table.table.cat-cards tbody tr td:nth-child(5),
    table.table.cat-cards tbody tr th:nth-child(1),
    table.table.cat-cards tbody tr th:nth-child(3),
    table.table.cat-cards tbody tr th:nth-child(5){
      position:absolute !important;
      left:-99999px !important;
      top:auto !important;
      width:1px !important;
      height:1px !important;
      overflow:hidden !important;
      opacity:0 !important;
      pointer-events:none !important;
    }

    @media (max-width: 540px){
      table.table.cat-cards tbody{ grid-template-columns: 1fr 1fr; }
      table.table.cat-cards tbody tr{
        grid-template-areas:
          "name name"
          "color color"
          "actions actions";
        grid-template-columns: 1fr;
      }
      table.table.cat-cards tbody tr td:nth-child(6),
      table.table.cat-cards tbody tr th:nth-child(6){
        flex-direction: row;
        justify-content:flex-start;
        align-items:center;
        min-width: 0;
      }
    }
    @media (max-width: 380px){
      table.table.cat-cards tbody{ grid-template-columns: 1fr; }
    }

    /* ===========================
       ✅ MODALES PRO + 2x2 compacto
       =========================== */
    @keyframes popIn {
      from { transform: translateY(10px) scale(.98); opacity: 0; }
      to   { transform: translateY(0) scale(1); opacity: 1; }
    }
    .modal.show .modal-dialog{ animation: popIn .18s ease-out; }

    .modal .modal-dialog{
      margin: 140px auto 1.25rem !important;
      max-width: 540px;
    }
    @media (max-width: 540px){
      .modal .modal-dialog{ margin-top: 120px !important; max-width: calc(100vw - 18px); }
    }

    .modal-content,
    .swal2-popup{
      background: rgba(0,0,0,.90) !important;
      color: var(--text) !important;
      border-radius: 18px !important;
      border: 1px solid rgba(167,139,250,.18) !important;
      box-shadow: var(--shadow), 0 0 0 1px rgba(34,211,238,.06) !important;
      backdrop-filter: blur(14px);
      overflow: hidden;
    }

    .modal-header, .modal-footer{
      border-color: rgba(167,139,250,.12) !important;
      background:
        linear-gradient(90deg, rgba(34,211,238,.12), rgba(0,0,0,.92), rgba(139,92,246,.14)) !important;
    }

    .modal-title{
      letter-spacing:.14em;
      text-transform: uppercase;
      font-weight: 950;
    }

    .btn-close{
      filter: invert(1) brightness(1.15);
      opacity: .85;
    }
    .btn-close:hover{ opacity: 1; }

    .modal input, .modal select, .modal textarea{
      background: rgba(7,10,18,.86) !important;
      color: var(--text) !important;
      border: 1px solid rgba(167,139,250,.18) !important;
      border-radius: 12px !important;
      padding: .42rem .65rem !important;
      min-height: 38px;
      font-size: .92rem;
    }

    .modal .modal-body .form-row-2,
    .modal .modal-body .form-row-2b{
      display:grid;
      grid-template-columns: 1fr 150px;
      gap: 10px;
      align-items:end;
    }
    @media (max-width: 540px){
      .modal .modal-body .form-row-2,
      .modal .modal-body .form-row-2b{
        grid-template-columns: 1fr;
      }
    }

    .modal label{
      font-size: .82rem;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: rgba(170,179,214,.92);
      font-weight: 900;
      margin-bottom: 6px;
    }

    .modal-footer .btn{
      border-radius: 14px !important;
      font-weight: 950 !important;
      letter-spacing:.10em !important;
      text-transform: uppercase !important;
      padding: .62rem 1rem !important;
      border: 1px solid rgba(34,211,238,.18) !important;
      color: var(--text) !important;
      background:
        radial-gradient(120px 60px at 20% 30%, rgba(34,211,238,.16), transparent 62%),
        radial-gradient(160px 60px at 70% 30%, rgba(139,92,246,.22), transparent 65%),
        linear-gradient(135deg, rgba(0,0,0,.92), rgba(7,10,18,.80)) !important;
      box-shadow: var(--softGlow2) !important;
      transition: transform .08s ease, filter .2s ease, box-shadow .2s ease;
    }
    .modal-footer .btn:hover{
      transform: translateY(-1px);
      filter: brightness(1.04);
      box-shadow: 0 0 0 1px rgba(34,211,238,.14), 0 22px 46px rgba(0,0,0,.70) !important;
    }
  </style>
</head>

<body>
  <script src="//cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.js"></script>

  <main class="d-flex">
    <%~ include("./sidebar", it) %>
    <div class="container-fluid p-0">
      <%~ include("./header", it) %>

      <div class="content pt-1 overflow-auto">
        <div class="card h-100 border border-0 shadow overflow-auto">
          <div class="card-body m-0">

            <h1 class="mt-2 h3 mb-4 text-gray-800">CATEGORÍAS</h1>

            <div class="d-md-flex justify-content-between align-items-end mb-3 gap-2">
              <div class="col-md-2">
                <span class="mini-label">Ver</span>
                <select class="__status form-select mb-2"></select>
              </div>

              <div class="col-md-3 d-flex justify-content-center align-items-center mb-2 text-nowrap">
                <button type="button" class="__btn__add btn btn-dark w-100">
                  <i class="bi bi-plus-lg"></i>
                  NUEVA
                </button>

                <!-- ✅ Hook para main.js (oculto, no rompe guardar) -->
                <button type="button" class="__btn__delete btn btn-dark w-100 dt-hidden-hook" aria-hidden="true" tabindex="-1">
                  <i class="bi bi-trash"></i>
                  ELIMINAR
                </button>
              </div>
            </div>

            <div id="root"></div>
            <div id="pagination"></div>

          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="../static/js/sidebar.js"></script>
  <script src="../static/js/utils.js"></script>
  <script src="../static/js/jscolor.js"></script>
  <script type="module" src="../static/js/category/main.js"></script>

  <script>
    /* ✅ Pull to refresh REAL sobre el contenedor que scrollea (la card) */
    (function enablePullToRefresh(){
      const getScroller = () => document.querySelector('.content > .card') || document.querySelector('.content');
      const scroller = getScroller();
      if (!scroller) return;

      let startY = 0;
      let pulling = false;

      const start = (e) => {
        if (scroller.scrollTop > 0) return;
        startY = e.touches ? e.touches[0].clientY : e.clientY;
        pulling = true;
      };

      const move = (e) => {
        if (!pulling) return;
        if (scroller.scrollTop > 0) { pulling = false; return; }
        const y = e.touches ? e.touches[0].clientY : e.clientY;
        const dy = y - startY;
        if (dy > 120) {
          pulling = false;
          location.reload();
        }
      };

      const end = () => pulling = false;

      scroller.addEventListener('touchstart', start, { passive:true });
      scroller.addEventListener('touchmove', move, { passive:true });
      scroller.addEventListener('touchend', end, { passive:true });
    })();

    /* ✅ Cards: activar look sin romper DOM */
    const normalizeColor = (s) => {
      const t = (s || '').trim();
      if (!t) return '';
      const hex = t.match(/#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})\b/);
      if (hex) return hex[0];
      if (/^[0-9a-fA-F]{6}$/.test(t)) return '#' + t;
      const rgb = t.match(/rgb(a)?\(([^)]+)\)/i);
      if (rgb) return rgb[0];
      return '';
    };

    function applyCardsWithoutBreakingDom(){
      const root = document.querySelector('#root');
      if (!root) return;

      const table = root.querySelector('table.table');
      if (!table) return;

      table.classList.add('cat-cards');

      // wrapper responsive
      if (!table.closest('.table-responsive')) {
        const w = document.createElement('div');
        w.className = 'table-responsive';
        table.parentNode.insertBefore(w, table);
        w.appendChild(table);
      }

      table.querySelectorAll('tbody tr').forEach(tr => {
        // Nombre limpio (TD2) sin borrar contenido real
        const nameTd = tr.querySelector('td:nth-child(2), th:nth-child(2)');
        if (nameTd && !nameTd.querySelector('.dt-cat-name')) {
          const raw = (nameTd.textContent || '').trim();
          const label = document.createElement('span');
          label.className = 'dt-cat-name';
          label.textContent = raw || '—';
          nameTd.insertBefore(label, nameTd.firstChild);
        }

        // Color dot (TD4)
        const colorTd = tr.querySelector('td:nth-child(4), th:nth-child(4)');
        if (colorTd && !colorTd.querySelector('.dt-color-dot')) {
          const fromText = normalizeColor(colorTd.textContent || '');
          const fromInput = normalizeColor(colorTd.querySelector('input,select,textarea')?.value || '');
          const c = fromText || fromInput;
          if (c) {
            const dot = document.createElement('span');
            dot.className = 'dt-color-dot';
            dot.title = c;
            dot.style.background = c;
            colorTd.appendChild(dot);
          }
        }

        // Ocultar copiar SOLO visualmente en acciones (TD6), sin remove()
        const actsTd = tr.querySelector('td:nth-child(6), th:nth-child(6)');
        if (actsTd) {
          actsTd.querySelectorAll('button, a').forEach(btn => {
            const ico = btn.querySelector('i');
            const iconClass = ico ? (ico.className || '') : '';
            const t = ((btn.getAttribute('title') || '') + ' ' + (btn.textContent || '')).toLowerCase();
            const looksLikeCopy =
              iconClass.includes('clipboard') ||
              iconClass.includes('bi-copy') ||
              iconClass.includes('bi-files') ||
              t.includes('copiar') ||
              t.includes('copy') ||
              t.includes('duplic');
            if (looksLikeCopy) btn.style.display = 'none';
          });
        }
      });
    }

    const obs = new MutationObserver(() => applyCardsWithoutBreakingDom());

    window.addEventListener('DOMContentLoaded', () => {
      applyCardsWithoutBreakingDom();
      const root = document.querySelector('#root');
      if (root) obs.observe(root, { childList:true, subtree:true });
    });

    /* ✅ Modal: re-orden automático a 2x2 (Nombre+Orden / Estado+Color) */
    const styleCategoryModalLayout = () => {
      document.querySelectorAll('.modal').forEach(modal => {
        if (modal.dataset.layoutDone === "1") return;

        const body = modal.querySelector('.modal-body');
        if (!body) return;

        const groups = Array.from(body.querySelectorAll('.mb-3, .form-group, .row, .col, .input-group'));
        if (groups.length < 4) return;

        const findGroupByLabel = (keywords) => {
          return groups.find(g => {
            const lab = (g.querySelector('label')?.textContent || g.textContent || '').toLowerCase();
            return keywords.some(k => lab.includes(k));
          });
        };

        const gName  = findGroupByLabel(['nome','nombre']);
        const gOrder = findGroupByLabel(['ordem','orden','order']);
        const gStatus= findGroupByLabel(['status','estado']);
        const gColor = findGroupByLabel(['cor','color']);

        if (!gName || !gOrder || !gStatus || !gColor) return;

        const row1 = document.createElement('div');
        row1.className = 'form-row-2 mb-3';

        const row2 = document.createElement('div');
        row2.className = 'form-row-2b mb-3';

        body.insertBefore(row1, gName);
        row1.appendChild(gName);
        row1.appendChild(gOrder);

        body.insertBefore(row2, gStatus);
        row2.appendChild(gStatus);
        row2.appendChild(gColor);

        modal.dataset.layoutDone = "1";
      });
    };

    document.addEventListener('shown.bs.modal', () => styleCategoryModalLayout());
    window.addEventListener('DOMContentLoaded', () => styleCategoryModalLayout());
  </script>
</body>
</html>