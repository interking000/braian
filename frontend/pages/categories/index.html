<!DOCTYPE html>
<html lang="es-AR" translate="no" data-bs-theme="dark">

<head>
  <base href="/" target="_blank">
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="google" content="notranslate">
  <link rel="shortcut icon" href="../static/img/favicon.svg" />
  <title>KING•VPN - Categorías</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <link rel="stylesheet" href="../static/css/styles.css">
  <link rel="stylesheet" href="../static/css/bootstrap.css">
  <link rel="stylesheet" href="../static/css/sidebar.css">
  <link rel="stylesheet" href="../static/css/header.css">

  <script src="../static/js/dark_light.js"></script>
  <script src="//code.jquery.com/jquery-2.1.0.min.js"></script>
  <link href="//cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.css" rel="stylesheet" />
  <meta name="csrf-token" content="<%= it.csrfToken %>">

  <style>
    :root{
      --bg1:#070A10; --bg2:#0B1020;
      --panel:#0E1424; --panel2:#0B1020;

      /* KING: violeta + verde */
      --accent:#8B5CF6;
      --accent2:#22C55E;
      --accent3:#A78BFA;

      --text:#EAF0FF; --muted:#AAB3D6;
      --radius:18px;

      --shadow: 0 18px 55px rgba(0,0,0,.65);
      --ring: 0 0 0 3px rgba(34,197,94,.16);
      --softGlow: 0 0 0 1px rgba(167,139,250,.14), 0 12px 28px rgba(0,0,0,.55);

      --header-safe: 46px;
    }

    html, body{ height:100%; }

    body{
      min-height:100vh;
      color:var(--text);
      background:
        radial-gradient(950px 520px at 18% 12%, rgba(139,92,246,.18), transparent 62%),
        radial-gradient(900px 520px at 82% 14%, rgba(34,197,94,.13), transparent 60%),
        radial-gradient(900px 620px at 50% 92%, rgba(167,139,250,.10), transparent 62%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      background-attachment: fixed;
      overflow-x:hidden;
      padding-top: var(--header-safe);
    }

    main.d-flex{ min-height:100vh; justify-content:flex-start !important; align-items:stretch; }
    .container-fluid{ width:100%; max-width:none !important; }

    .content{
      padding: 16px;
      min-height: calc(100vh - var(--header-safe));
    }

    .content > .card{
      border-radius: calc(var(--radius) + 6px);
      background: linear-gradient(180deg, rgba(14,20,36,.92), rgba(11,16,32,.92));
      border: 1px solid rgba(167,139,250,.24) !important;
      box-shadow: var(--shadow), 0 0 0 1px rgba(34,197,94,.045);
      backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
    }

    .content > .card::before{
      content:"";
      position:absolute; inset:-2px -2px auto -2px; height: 110px;
      background:
        radial-gradient(380px 110px at 16% 30%, rgba(139,92,246,.22), transparent 65%),
        radial-gradient(560px 110px at 70% 30%, rgba(34,197,94,.16), transparent 65%),
        linear-gradient(90deg, rgba(139,92,246,.10), rgba(34,197,94,.06));
      pointer-events:none;
      border-bottom: 1px solid rgba(167,139,250,.14);
    }

    .card-body{ position:relative; }

    .text-gray-800{
      color: var(--text) !important;
      letter-spacing: .14em;
      text-shadow:none;
      text-transform: uppercase;
    }

    .form-select, .form-control, .input-group-text{
      background: rgba(7,10,18,.86) !important;
      color: var(--text) !important;
      border: 1px solid rgba(167,139,250,.18) !important;
      border-radius: 14px !important;
    }
    .form-select:focus, .form-control:focus{
      box-shadow: var(--ring) !important;
      border-color: rgba(34,197,94,.32) !important;
    }

    /* ===== Botones top (pequeños, pro) ===== */
    .btn{
      border-radius: 14px !important;
      border: 1px solid rgba(167,139,250,.18) !important;
      color: var(--text) !important;
      transition: transform .08s ease, box-shadow .2s ease, filter .2s ease;
      box-shadow: 0 10px 22px rgba(0,0,0,.42);
      background: rgba(7,10,18,.72);
      font-weight: 900;
      letter-spacing: .10em;
      text-transform: uppercase;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: var(--softGlow); filter: brightness(1.03); }
    .btn:active{ transform: translateY(0); filter: brightness(.99); }

    .btn-king-sm{
      padding: .42rem .7rem !important;
      font-size: .78rem !important;
      letter-spacing: .12em !important;
      background:
        radial-gradient(140px 60px at 20% 30%, rgba(34,197,94,.14), transparent 60%),
        radial-gradient(200px 70px at 70% 30%, rgba(139,92,246,.18), transparent 65%),
        rgba(7,10,18,.72) !important;
      border-color: rgba(34,197,94,.18) !important;
    }
    .btn-king-sm i{ color: rgba(34,197,94,.92); }

    .btn-edit-soft{
      padding: .42rem .7rem !important;
      font-size: .78rem !important;
      letter-spacing: .12em !important;
      background:
        radial-gradient(160px 70px at 20% 30%, rgba(139,92,246,.22), transparent 62%),
        radial-gradient(220px 70px at 80% 30%, rgba(34,197,94,.10), transparent 65%),
        rgba(7,10,18,.72) !important;
      border: 1px solid rgba(139,92,246,.22) !important;
      box-shadow: 0 0 0 1px rgba(167,139,250,.10), 0 12px 28px rgba(0,0,0,.55);
    }
    .btn-edit-soft i{ color: rgba(167,139,250,.95); }

    .btn-danger-soft{
      padding: .42rem .7rem !important;
      font-size: .78rem !important;
      letter-spacing: .12em !important;
      background:
        radial-gradient(120px 70px at 20% 30%, rgba(239,68,68,.18), transparent 62%),
        rgba(7,10,18,.72) !important;
      border: 1px solid rgba(239,68,68,.22) !important;
      box-shadow: 0 0 0 1px rgba(239,68,68,.10), 0 12px 28px rgba(0,0,0,.55);
    }
    .btn-danger-soft i{ color: rgba(248,113,113,.95); }

    /* =========================================================
       TABLA -> CARDS 2×2 (sin romper tu JS)
       ========================================================= */
    .table-responsive{
      border-radius: 18px;
      border: 1px solid rgba(167,139,250,.16);
      background: rgba(11,16,32,.58);
      box-shadow: inset 0 0 0 1px rgba(34,197,94,.03);
      overflow: hidden;
      padding: 10px;
    }

    table.table.neon-cards-cat{ width:100%; margin:0; }
    table.table.neon-cards-cat thead{ display:none !important; }

    table.table.neon-cards-cat tbody{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    table.table.neon-cards-cat tbody tr{
      position: relative;
      display:grid;
      grid-template-columns: 44px 1fr;
      grid-auto-rows: min-content;
      gap: 8px 10px;

      border-radius: 16px;
      background: rgba(11,16,32,.86);
      border: 1px solid rgba(167,139,250,.16);
      box-shadow: 0 0 0 1px rgba(34,197,94,.04), 0 16px 28px rgba(0,0,0,.45);
      padding: 12px;
      overflow: hidden;

      min-height: 110px;
      max-height: 140px;
    }

    table.table.neon-cards-cat tbody tr::before{
      content:"";
      position:absolute; inset:0 0 auto 0; height:44px;
      background:
        radial-gradient(240px 44px at 20% 30%, rgba(34,197,94,.10), transparent 65%),
        radial-gradient(360px 44px at 70% 30%, rgba(139,92,246,.12), transparent 65%);
      border-bottom: 1px solid rgba(167,139,250,.10);
      pointer-events:none;
    }

    table.table.neon-cards-cat td,
    table.table.neon-cards-cat th{
      border: 0 !important;
      background: transparent !important;
      color: var(--text) !important;
      padding: 0 !important;
      z-index: 2;
    }

    table.table.neon-cards-cat td:first-child,
    table.table.neon-cards-cat th:first-child{
      grid-column: 1;
      grid-row: 1 / span 99;
      align-self: start;
      padding-top: 8px !important;
    }

    table.table.neon-cards-cat td:last-child{
      grid-column: 2;
      justify-self: end;
      align-self: center;
      display:flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    table.table.neon-cards-cat td:not(:first-child):not(:last-child){
      grid-column: 2;
      display:flex;
      align-items:center;
      gap: 8px;

      font-weight: 650;
      font-size: .90rem;
      line-height: 1.2;
      color: rgba(234,240,255,.96) !important;

      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    table.table.neon-cards-cat td:not(:first-child):not(:last-child)::before{
      content: attr(data-label) ":";
      display:inline-block;
      font-size:.70rem;
      letter-spacing:.10em;
      text-transform:uppercase;
      color: rgba(170,179,214,.75);
      font-weight: 900;
      flex: 0 0 auto;
    }

    /* ===== Acciones por fila: SIEMPRE visibles + color correcto ===== */
    table.table.neon-cards-cat td:last-child button,
    table.table.neon-cards-cat td:last-child a{
      width: 42px;
      height: 36px;
      display:inline-flex !important;
      align-items:center;
      justify-content:center;
      padding:0 !important;
      border-radius: 12px !important;
      background: rgba(7,10,18,.70) !important;
      border: 1px solid rgba(167,139,250,.16) !important;
      box-shadow: 0 0 0 1px rgba(34,197,94,.05), 0 10px 18px rgba(0,0,0,.45);
      opacity: 1 !important;
      visibility: visible !important;
    }

    /* EDITAR (violeta) — detecta muchos patrones */
    table.table.neon-cards-cat td:last-child a[href*="edit"] i,
    table.table.neon-cards-cat td:last-child button[class*="edit"] i,
    table.table.neon-cards-cat td:last-child a[class*="edit"] i,
    table.table.neon-cards-cat td:last-child button[data-action="edit"] i,
    table.table.neon-cards-cat td:last-child a[data-action="edit"] i,
    table.table.neon-cards-cat td:last-child .bi-pencil i,
    table.table.neon-cards-cat td:last-child .bi-pencil-square i,
    table.table.neon-cards-cat td:last-child i.bi-pencil,
    table.table.neon-cards-cat td:last-child i.bi-pencil-square{
      color: rgba(167,139,250,.95) !important;
    }

    /* ELIMINAR (rojo) — detecta muchos patrones */
    table.table.neon-cards-cat td:last-child a[href*="delete"] i,
    table.table.neon-cards-cat td:last-child button[class*="delete"] i,
    table.table.neon-cards-cat td:last-child a[class*="delete"] i,
    table.table.neon-cards-cat td:last-child button[data-action="delete"] i,
    table.table.neon-cards-cat td:last-child a[data-action="delete"] i,
    table.table.neon-cards-cat td:last-child i.bi-trash,
    table.table.neon-cards-cat td:last-child i.bi-trash3{
      color: rgba(248,113,113,.95) !important;
    }

    @media (max-width: 540px){
      table.table.neon-cards-cat tbody{ grid-template-columns: 1fr; }
      table.table.neon-cards-cat td:last-child{ justify-self: start; }
    }

    #pagination .page-link{
      background: rgba(7,10,18,.86) !important;
      color: var(--text) !important;
      border: 1px solid rgba(167,139,250,.14) !important;
    }
    #pagination .page-link:focus{ box-shadow: var(--ring) !important; }
  </style>
</head>

<body>
  <script src="//cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.js"></script>

  <main class="d-flex">
    <%~ include("./sidebar", it) %>

    <div class="container-fluid p-0">
      <%~ include("./header", it) %>

      <div class="content pt-1 overflow-auto">
        <div class="card h-100 border border-0 shadow overflow-auto">
          <div class="card-body m-0">

            <h1 class="mt-2 h3 mb-4 text-gray-800">CATEGORÍAS</h1>

            <div class="d-md-flex justify-content-between align-items-center mb-3">
              <div class="col-md-2">
                <select class="__status form-select mb-2"></select>
              </div>

              <!-- ✅ TOP ACTIONS: ahora EDITAR usa la MISMA lógica que tu tabla -->
              <div class="col-md-5 d-flex justify-content-center align-items-center mb-2 text-nowrap gap-2">
                <button type="button" class="__btn__add btn btn-king-sm w-100">
                  <i class="bi bi-plus-lg"></i>
                  NUEVO
                </button>

                <!-- ✅ IMPORTANTE: este botón NO edita “por su cuenta”.
                     Dispara el botón editar REAL de la fila seleccionada. -->
                <button type="button" class="__btn__edit_proxy btn btn-edit-soft w-100">
                  <i class="bi bi-pencil-square"></i>
                  EDITAR
                </button>

                <button type="button" class="__btn__delete btn btn-danger-soft w-100">
                  <i class="bi bi-trash"></i>
                  ELIMINAR
                </button>
              </div>
            </div>

            <div id="root"></div>
            <div id="pagination"></div>

          </div>
        </div>
      </div>

    </div>
  </main>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="../static/js/sidebar.js"></script>
  <script src="../static/js/utils.js"></script>

  <script>
    // ✅ Cardify SEGURO para CATEGORÍAS: no mueve elementos, solo agrega class + data-label
    const applyCategoryNeonCardsSafely = () => {
      const root = document.querySelector('#root');
      if (!root) return;

      const table = root.querySelector('table.table');
      if (!table) return;

      if (table.dataset.neonCardsCat === "1") return;
      table.dataset.neonCardsCat = "1";
      table.classList.add('neon-cards-cat');

      const ths = table.querySelectorAll('thead th');
      let labels = [];
      if (ths && ths.length) {
        labels = Array.from(ths).map(th => (th.textContent || "").trim());
      }

      const fallback = ["", "Nombre", "Color", "Estado", "Acciones"];

      const rows = table.querySelectorAll('tbody tr');
      rows.forEach(tr => {
        const cells = tr.querySelectorAll('td, th');
        if (!cells || !cells.length) return;

        for (let i = 0; i < cells.length; i++) {
          const cell = cells[i];
          const label = (labels[i] && labels[i].length) ? labels[i] : (fallback[i] || "");
          cell.setAttribute('data-label', label);
        }
      });
    };

    // ✅ Encuentra el botón EDITAR REAL dentro de una fila (lo que crea tu main.js)
    const findRealEditButtonInRow = (tr) => {
      if (!tr) return null;

      // Probamos varios selectores comunes (sin romper nada)
      const candidates = [
        'a[href*="edit"]',
        'button[class*="edit"]',
        'a[class*="edit"]',
        'button[data-action="edit"]',
        'a[data-action="edit"]',
        'button:has(i.bi-pencil)',
        'button:has(i.bi-pencil-square)',
        'a:has(i.bi-pencil)',
        'a:has(i.bi-pencil-square)',
      ];

      for (const sel of candidates) {
        try {
          const el = tr.querySelector(sel);
          if (el) return el;
        } catch {}
      }

      // Fallback: buscar un botón/link que tenga icono de lápiz
      const icon = tr.querySelector('i.bi-pencil, i.bi-pencil-square');
      if (icon) return icon.closest('a,button');

      return null;
    };

    // ✅ Botón EDITAR de arriba -> dispara el editar real de la fila seleccionada
    const bindTopEditProxy = () => {
      const btnProxy = document.querySelector('.__btn__edit_proxy');
      if (!btnProxy) return;

      btnProxy.addEventListener('click', () => {
        const root = document.querySelector('#root');
        const table = root ? root.querySelector('table.table') : null;
        if (!table) {
          try { toastr.error('Todavía no cargó la tabla.'); } catch {}
          return;
        }

        // busca checkbox marcado (selección)
        const checked = table.querySelector('tbody input[type="checkbox"]:checked');
        if (!checked) {
          try { toastr.warning('Seleccioná una categoría (checkbox) para editar.'); } catch {}
          return;
        }

        const tr = checked.closest('tr');
        const editBtn = findRealEditButtonInRow(tr);

        if (!editBtn) {
          try { toastr.error('No encontré el botón EDITAR real en esa fila.'); } catch {}
          return;
        }

        // dispara la misma acción que tu sistema ya usa
        editBtn.click();
      });
    };

    const rootObserver = new MutationObserver(() => {
      applyCategoryNeonCardsSafely();
      bindTopEditProxy();
    });

    window.addEventListener('DOMContentLoaded', () => {
      const root = document.querySelector('#root');
      if (root) {
        applyCategoryNeonCardsSafely();
        bindTopEditProxy();
        rootObserver.observe(root, { childList: true, subtree: true });
      }
    });
  </script>

  <script src="../static/js/jscolor.js"></script>
  <script type="module" src="../static/js/category/main.js"></script>
</body>

</html>
