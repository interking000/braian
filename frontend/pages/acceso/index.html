<!DOCTYPE html>
<html lang="es-AR" translate="no" data-bs-theme="dark">
<head>
  <base href="/" target="_self">
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="google" content="notranslate">
  <link rel="shortcut icon" href="../static/img/favicon.svg" />
  <title>DTunnelMod - Acceso</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="csrf-token" content="<%= it.csrfToken %>">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.css" />

  <link rel="stylesheet" href="../static/css/styles.css">
  <link rel="stylesheet" href="../static/css/bootstrap.css">
  <link rel="stylesheet" href="../static/css/sidebar.css">
  <link rel="stylesheet" href="../static/css/header.css">

  <script src="../static/js/dark_light.js"></script>
  <script src="//code.jquery.com/jquery-2.1.0.min.js"></script>

  <style>
    :root{
      --bg1:#070A10;
      --bg2:#0B1020;

      --accent:#8B5CF6;
      --accent2:#22D3EE;
      --accent3:#A78BFA;

      --line: rgba(167,139,250,.18);

      --text:#EAF0FF;
      --muted:#AAB3D6;

      --radius:18px;

      --shadow: 0 18px 55px rgba(0,0,0,.65);
      --ring: 0 0 0 3px rgba(139,92,246,.18);
      --softGlow: 0 0 0 1px rgba(167,139,250,.12), 0 12px 28px rgba(0,0,0,.55);
      --softGlow2: 0 0 0 1px rgba(34,211,238,.12), 0 18px 40px rgba(0,0,0,.62);
    }

    html, body{ height:100%; }
    body,
    body[data-bs-theme="light"],
    body[data-bs-theme="dark"]{
      min-height:100vh !important;
      color:var(--text) !important;
      background:
        radial-gradient(950px 520px at 18% 12%, rgba(139,92,246,.18), transparent 62%),
        radial-gradient(900px 520px at 82% 14%, rgba(34,211,238,.14), transparent 60%),
        radial-gradient(900px 620px at 50% 92%, rgba(167,139,250,.10), transparent 62%),
        linear-gradient(135deg, var(--bg1), var(--bg2)) !important;
      background-attachment: fixed !important;
      overflow-x:hidden;
    }
    .container-fluid, main.d-flex{ background: transparent !important; }
    main.d-flex{ min-height:100vh; justify-content:center; }
    .container-fluid{ max-width: 1250px; width: 100%; }

    .content{
      display:flex; justify-content:center; align-items:center;
      min-height: calc(100vh - 80px);
      padding: 16px;
    }

    .content > .card{
      width:100%;
      max-width:1120px;
      max-height: calc(100vh - 120px);
      border-radius: calc(var(--radius) + 6px);
      background: linear-gradient(180deg, rgba(14,20,36,.92), rgba(11,16,32,.88));
      border: 1px solid rgba(167,139,250,.18) !important;
      box-shadow: var(--shadow), 0 0 0 1px rgba(34,211,238,.05);
      backdrop-filter: blur(10px);
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }
    .card-body{ padding: 18px; }

    .text-gray-800{
      color: var(--text) !important;
      letter-spacing: .14em;
      text-transform: uppercase;
      font-weight: 900;
    }
    .muted{ color: rgba(170,179,214,.82); }
    .tiny{ font-size: .86rem; }

    .btn{
      border-radius: 14px !important;
      border: 1px solid rgba(167,139,250,.16) !important;
      color: var(--text) !important;
      background: rgba(7,10,18,.70) !important;
      box-shadow: 0 0 0 1px rgba(34,211,238,.04), 0 10px 18px rgba(0,0,0,.40);
      transition: transform .08s ease, box-shadow .2s ease, filter .2s ease;
      font-weight: 800;
      letter-spacing:.06em;
      text-transform: uppercase;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: var(--softGlow2); filter: brightness(1.03); }
    .btn:active{ transform: translateY(0px); }

    .btn-primary-ish{
      border-color: rgba(34,211,238,.22) !important;
      background:
        radial-gradient(120px 60px at 20% 30%, rgba(34,211,238,.16), transparent 62%),
        radial-gradient(160px 60px at 70% 30%, rgba(139,92,246,.22), transparent 65%),
        linear-gradient(135deg, rgba(0,0,0,.92), rgba(7,10,18,.80)) !important;
      box-shadow: var(--softGlow2) !important;
    }

    /* ===== Hero box (dentro de la card) ===== */
    .hero{
      border-radius: 18px;
      border: 1px solid rgba(167,139,250,.16);
      background: rgba(0,0,0,.55);
      box-shadow: inset 0 0 0 1px rgba(34,211,238,.04);
      padding: 14px;
    }
    .hero-grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 12px;
      align-items: stretch;
    }
    @media (max-width: 980px){ .hero-grid{ grid-template-columns: 1fr; } }

    .panel{
      border-radius: 18px;
      border: 1px solid rgba(34,211,238,.14);
      background: rgba(0,0,0,.86);
      box-shadow: 0 0 0 1px rgba(34,211,238,.05), 0 16px 28px rgba(0,0,0,.55);
      overflow: hidden;
    }
    .panel-head{
      padding: 12px 14px;
      background:
        radial-gradient(260px 60px at 20% 30%, rgba(34,211,238,.10), transparent 62%),
        radial-gradient(320px 60px at 70% 30%, rgba(139,92,246,.14), transparent 65%),
        rgba(0,0,0,.55);
      border-bottom: 1px solid rgba(167,139,250,.12);
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 12px;
    }
    .panel-title{
      margin:0;
      font-weight: 950;
      font-size: .98rem;
      letter-spacing:.10em;
      text-transform: uppercase;
    }
    .panel-sub{
      margin: 6px 0 0;
      color: rgba(170,179,214,.90);
      font-weight: 750;
      font-size: .86rem;
      line-height: 1.35rem;
    }
    .panel-body{ padding: 14px; }

    .step{
      display:flex;
      gap: 10px;
      align-items:flex-start;
      padding: 10px 10px;
      border-radius: 16px;
      border: 1px solid rgba(34,211,238,.12);
      background: rgba(7,10,18,.48);
      box-shadow: inset 0 0 0 1px rgba(34,211,238,.04);
      margin-top: 10px;
    }
    .dot{
      width: 34px; height: 34px;
      border-radius: 999px;
      display:flex;
      align-items:center;
      justify-content:center;
      border: 1px solid rgba(34,211,238,.18);
      background: rgba(34,211,238,.10);
      flex: 0 0 auto;
      margin-top: 1px;
    }
    .dot i{ color: rgba(34,211,238,.95); }
    .step b{
      display:block;
      font-weight: 950;
      letter-spacing: .08em;
      font-size: .82rem;
      text-transform: uppercase;
    }
    .step span{
      display:block;
      color: rgba(170,179,214,.86);
      font-size: .86rem;
      line-height: 1.45;
      margin-top: 2px;
    }

    .status{
      margin-top: 12px;
      text-align:center;
      font-size: .86rem;
      color: rgba(170,179,214,.90);
    }
    .status.ok{ color: rgba(34,211,238,.96); font-weight: 900; }
    .status.err{ color: #ff4d4d; font-weight: 900; }
    .status.warn{ color: rgba(255,211,77,.98); font-weight: 900; }

    /* ===========================
       ✅ MODALES PRO (igual estilo)
       =========================== */
    @keyframes popIn {
      from { transform: translateY(10px) scale(.98); opacity: 0; }
      to   { transform: translateY(0) scale(1); opacity: 1; }
    }
    .modal.show .modal-dialog{ animation: popIn .18s ease-out; }

    .modal .modal-dialog{
      margin: 140px auto 1.25rem !important;
      max-width: 820px;
    }
    @media (max-width: 540px){
      .modal .modal-dialog{ margin-top: 120px !important; max-width: calc(100vw - 18px); }
    }

    .modal-content{
      background: rgba(0,0,0,.90) !important;
      color: var(--text) !important;
      border-radius: 18px !important;
      border: 1px solid rgba(167,139,250,.18) !important;
      box-shadow: var(--shadow), 0 0 0 1px rgba(34,211,238,.06) !important;
      backdrop-filter: blur(14px);
      overflow: hidden;
    }
    .modal-header, .modal-footer{
      border-color: rgba(167,139,250,.12) !important;
      background:
        linear-gradient(90deg, rgba(34,211,238,.12), rgba(0,0,0,.92), rgba(139,92,246,.14)) !important;
    }
    .modal-title{
      letter-spacing:.14em;
      text-transform: uppercase;
      font-weight: 950;
    }
    .btn-close{ filter: invert(1) brightness(1.15); opacity: .85; }
    .btn-close:hover{ opacity: 1; }

    /* ✅ Sidebar SIEMPRE arriba del modal */
    .sidebar{ z-index: 2005 !important; }
    .modal-backdrop{ z-index: 2000 !important; }
    .modal{ z-index: 2001 !important; }

    /* ===== Plan cards ===== */
    .plans-grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
    }
    @media (max-width: 980px){ .plans-grid{ grid-template-columns: 1fr; } }

    .plan-card{
      border-radius: 16px;
      background: rgba(0,0,0,.86);
      border: 1px solid rgba(167,139,250,.18);
      box-shadow: 0 0 0 1px rgba(34,211,238,.05), 0 16px 28px rgba(0,0,0,.55);
      overflow:hidden;
      position: relative;
    }
    .plan-head{
      padding: 10px 12px;
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 10px;
      background:
        radial-gradient(260px 60px at 20% 30%, rgba(34,211,238,.10), transparent 62%),
        radial-gradient(320px 60px at 70% 30%, rgba(139,92,246,.14), transparent 65%),
        rgba(0,0,0,.55);
      border-bottom: 1px solid rgba(167,139,250,.12);
    }
    .plan-name{
      font-weight: 950;
      font-size: .95rem;
      letter-spacing:.10em;
      text-transform: uppercase;
      margin: 0;
    }
    .plan-price{
      padding: 12px;
      font-size: 1.35rem;
      font-weight: 999;
      color: rgba(34,211,238,.96);
      text-shadow: 0 0 10px rgba(34,211,238,.18);
    }
    .plan-body{ padding: 12px; }
    .benefits{
      margin:0;
      padding:0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap: 8px;
      color: rgba(234,240,255,.90);
      font-weight: 750;
      font-size: .88rem;
    }
    .benefits li{ display:flex; gap:10px; align-items:flex-start; }
    .benefits i{ color: rgba(255,211,77,.96); margin-top: 2px; }

    .ribbon{
      position:absolute;
      top: 10px;
      right: 10px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,211,77,.16);
      border: 1px solid rgba(255,211,77,.22);
      color: rgba(255,211,77,.98);
      font-weight: 950;
      letter-spacing: .14em;
      font-size: .62rem;
      text-transform: uppercase;
      display:flex;
      align-items:center;
      gap:6px;
    }
  </style>
</head>

<body>
  <script src="//cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.js"></script>

  <main class="d-flex">
    <%~ include("./sidebar", it) %>
    <div class="container-fluid p-0">
      <%~ include("./header", it) %>

      <div class="content pt-1 overflow-auto">
        <div class="card h-100 border border-0 shadow overflow-auto">
          <div class="card-body m-0">

            <div class="d-flex align-items-start justify-content-between gap-3 flex-wrap">
              <div>
                <h1 class="mt-2 h3 mb-2 text-gray-800">ACCESO PREMIUM</h1>
                <div class="muted tiny">
                  Elegí un plan, pagá por Mercado Pago y el acceso se activa cuando llegue la confirmación (webhook).
                </div>
              </div>

              <div class="d-flex align-items-center gap-2">
                <button type="button" class="btn btn-primary-ish __btn__openAccess">
                  <i class="bi bi-stars"></i> VER PLANES
                </button>
                <button type="button" class="btn __btn__openInfo">
                  <i class="bi bi-info-circle"></i> INFO
                </button>
              </div>
            </div>

            <div class="mt-3 hero">
              <div class="hero-grid">
                <div class="panel">
                  <div class="panel-head">
                    <div style="min-width:0">
                      <h3 class="panel-title"><i class="bi bi-lightning-charge-fill"></i> ACTIVÁ TU ACCESO</h3>
                      <div class="panel-sub">
                        Comprá tu acceso para disfrutar de herramientas premium.
                        La activación se realiza <b>cuando el servidor confirme el pago</b>.
                      </div>
                    </div>
                  </div>
                  <div class="panel-body">
                    <div class="step">
                      <div class="dot"><i class="bi bi-bag-check-fill"></i></div>
                      <div>
                        <b>1) Elegí tu plan</b>
                        <span>Entrás en <b>VER PLANES</b> y seleccionás duración.</span>
                      </div>
                    </div>
                    <div class="step">
                      <div class="dot"><i class="bi bi-credit-card-2-front-fill"></i></div>
                      <div>
                        <b>2) Pagá seguro</b>
                        <span>Mercado Pago: tarjetas, transferencias y billeteras.</span>
                      </div>
                    </div>
                    <div class="step">
                      <div class="dot"><i class="bi bi-shield-check"></i></div>
                      <div>
                        <b>3) Confirmación</b>
                        <span>Cuando llega el webhook, se habilita automáticamente.</span>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="panel">
                  <div class="panel-head">
                    <div style="min-width:0">
                      <h3 class="panel-title"><i class="bi bi-person-badge-fill"></i> TU CUENTA</h3>
                      <div class="panel-sub">
                        Usuario: <b><%= (it.user && it.user.username) ? it.user.username : '—' %></b><br>
                        Email: <b><%= (it.user && it.user.email) ? it.user.email : '—' %></b>
                      </div>
                    </div>
                  </div>
                  <div class="panel-body">
                    <div class="muted tiny">
                      Si ya pagaste y todavía no figura, esperá unos minutos o reintentá.
                    </div>
                    <div class="status" id="pageStatus"></div>
                    <div class="d-flex gap-2 mt-3 flex-wrap">
                      <button class="btn __btn__openAccess" type="button">
                        <i class="bi bi-stars"></i> COMPRAR / RENOVAR
                      </button>
                      <button class="btn __btn__ping" type="button">
                        <i class="bi bi-arrow-repeat"></i> VERIFICAR
                      </button>
                    </div>
                  </div>
                </div>

              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- ===========================
       MODAL PLANES / COMPRA
       =========================== -->
  <div class="modal fade" id="accessModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">

        <div class="modal-header border-0">
          <h5 class="modal-title"><i class="bi bi-stars"></i> PLANES • ACCESO PREMIUM</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>

        <div class="modal-body">
          <div class="muted tiny mb-3">
            Elegí tu plan y tocá <b>COMPRAR</b>. Te redirigimos a Mercado Pago.
            La activación se completa cuando el servidor confirme el pago ✅
          </div>

          <div class="plans-grid">

            <div class="plan-card" data-buy="1" data-price="3000">
              <div class="plan-head">
                <div>
                  <h3 class="plan-name">1 MES</h3>
                  <div class="muted tiny">Ideal para probar</div>
                </div>
                <i class="bi bi-calendar2-week" style="color:rgba(34,211,238,.92); font-size:1.1rem;"></i>
              </div>
              <div class="plan-price" data-price-text>$ 3.000 ARS</div>
              <div class="plan-body">
                <ul class="benefits">
                  <li><i class="bi bi-check2-circle"></i> Acceso premium 30 días</li>
                  <li><i class="bi bi-check2-circle"></i> Renovación rápida</li>
                  <li><i class="bi bi-check2-circle"></i> Activación por confirmación</li>
                </ul>
                <button class="btn btn-primary-ish w-100 mt-3 __btn__buy" type="button" data-buy="1">
                  <i class="bi bi-bag-check"></i> COMPRAR
                </button>
              </div>
            </div>

            <div class="plan-card" data-buy="2" data-price="5500">
              <div class="ribbon"><i class="bi bi-stars"></i> TOP</div>
              <div class="plan-head">
                <div>
                  <h3 class="plan-name">2 MESES</h3>
                  <div class="muted tiny">Mejor precio/mes</div>
                </div>
                <i class="bi bi-gem" style="color:rgba(255,211,77,.95); font-size:1.1rem;"></i>
              </div>
              <div class="plan-price" data-price-text>$ 5.500 ARS</div>
              <div class="plan-body">
                <ul class="benefits">
                  <li><i class="bi bi-check2-circle"></i> Acceso premium 60 días</li>
                  <li><i class="bi bi-check2-circle"></i> Recomendado KING</li>
                  <li><i class="bi bi-check2-circle"></i> Activación por confirmación</li>
                </ul>
                <button class="btn btn-primary-ish w-100 mt-3 __btn__buy" type="button" data-buy="2">
                  <i class="bi bi-lightning"></i> COMPRAR
                </button>
              </div>
            </div>

            <div class="plan-card" data-buy="3" data-price="7500">
              <div class="plan-head">
                <div>
                  <h3 class="plan-name">3 MESES</h3>
                  <div class="muted tiny">Ideal revendedores</div>
                </div>
                <i class="bi bi-calendar2-heart" style="color:rgba(167,139,250,.92); font-size:1.1rem;"></i>
              </div>
              <div class="plan-price" data-price-text>$ 7.500 ARS</div>
              <div class="plan-body">
                <ul class="benefits">
                  <li><i class="bi bi-check2-circle"></i> Acceso premium 90 días</li>
                  <li><i class="bi bi-check2-circle"></i> Más estabilidad</li>
                  <li><i class="bi bi-check2-circle"></i> Activación por confirmación</li>
                </ul>
                <button class="btn btn-primary-ish w-100 mt-3 __btn__buy" type="button" data-buy="3">
                  <i class="bi bi-bag-check"></i> COMPRAR
                </button>
              </div>
            </div>

          </div>

          <div class="status" id="modalStatus"></div>
        </div>

        <div class="modal-footer border-0 d-flex justify-content-between">
          <button type="button" class="btn" data-bs-dismiss="modal">
            <i class="bi bi-x-lg"></i> CERRAR
          </button>
          <button type="button" class="btn __btn__openInfoFromModal">
            <i class="bi bi-info-circle"></i> VER DUDAS
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- ===========================
       MODAL INFO / DUDAS
       =========================== -->
  <div class="modal fade" id="infoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 720px;">
      <div class="modal-content">

        <div class="modal-header border-0">
          <h5 class="modal-title"><i class="bi bi-question-circle"></i> DUDAS / AYUDA</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>

        <div class="modal-body">
          <div class="panel" style="border-radius:16px;">
            <div class="panel-body">
              <h6 class="mb-2" style="letter-spacing:.12em; text-transform:uppercase; font-weight:950;">
                <i class="bi bi-shield-lock-fill" style="color:rgba(255,211,77,.95)"></i> ¿Cuándo se habilita?
              </h6>
              <div class="muted tiny">
                Se habilita cuando el servidor recibe la confirmación (webhook/informe) y registra el pago.
              </div>
            </div>
          </div>

          <div class="panel mt-2" style="border-radius:16px;">
            <div class="panel-body">
              <h6 class="mb-2" style="letter-spacing:.12em; text-transform:uppercase; font-weight:950;">
                <i class="bi bi-arrow-repeat" style="color:rgba(34,211,238,.92)"></i> ¿Y si tarda?
              </h6>
              <div class="muted tiny">
                Puede tardar unos minutos. Tocá <b>VERIFICAR</b> o reintentá más tarde.
              </div>
            </div>
          </div>

          <div class="panel mt-2" style="border-radius:16px;">
            <div class="panel-body">
              <h6 class="mb-2" style="letter-spacing:.12em; text-transform:uppercase; font-weight:950;">
                <i class="bi bi-credit-card-2-front-fill" style="color:rgba(167,139,250,.92)"></i> ¿Pago seguro?
              </h6>
              <div class="muted tiny">
                Sí. Mercado Pago admite tarjetas, transferencias y billeteras. La activación depende del pago confirmado.
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer border-0">
          <button type="button" class="btn w-100" data-bs-dismiss="modal">
            <i class="bi bi-x-lg"></i> CERRAR
          </button>
        </div>

      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="../static/js/sidebar.js"></script>
  <script src="../static/js/utils.js"></script>

  <script>
    // =========================
    // CONFIG
    // =========================
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || '';

    // ✅ tu endpoint
    const MP_CREATE_ENDPOINT = "/api/mp/create";

    const toastOk = (m) => (window.showToastSuccess ? showToastSuccess(m) : toastr.success(m));
    const toastErr = (m) => (window.showToastError ? showToastError(m) : toastr.error(m));

    const modalStatus = document.getElementById('modalStatus');
    const pageStatus = document.getElementById('pageStatus');

    function setModalStatus(type, text){
      modalStatus.className = 'status ' + (type || '');
      modalStatus.textContent = text || '';
    }
    function setPageStatus(type, text){
      pageStatus.className = 'status ' + (type || '');
      pageStatus.textContent = text || '';
    }

    function moneyARS(n){
      try { return Number(n).toLocaleString("es-AR"); } catch { return String(n); }
    }

    // Pintar precios por dataset
    (function paintPrices(){
      document.querySelectorAll('.plan-card').forEach(card => {
        const p = Number(card.getAttribute('data-price') || 0);
        const t = card.querySelector('[data-price-text]');
        if (t) t.textContent = '$ ' + moneyARS(p) + ' ARS';
      });
    })();

    // Modales
    const accessModal = new bootstrap.Modal(document.getElementById('accessModal'));
    const infoModal = new bootstrap.Modal(document.getElementById('infoModal'));

    document.querySelectorAll('.__btn__openAccess').forEach(b => b.addEventListener('click', () => {
      setModalStatus('', '');
      accessModal.show();
    }));

    document.querySelectorAll('.__btn__openInfo').forEach(b => b.addEventListener('click', () => infoModal.show()));

    document.querySelector('.__btn__openInfoFromModal').addEventListener('click', () => {
      accessModal.hide();
      setTimeout(() => infoModal.show(), 120);
    });

    // POST create payment
    async function createPayment(months, total){
      setModalStatus('warn', 'Creando pago seguro…');

      try{
        const res = await fetch(MP_CREATE_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'csrf-token': csrfToken, // ✅ CLAVE
          },
          body: JSON.stringify({ months, total })
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data?.message || 'Error creando el pago');
        if (!data?.init_point) throw new Error('No vino init_point');

        setModalStatus('ok', 'Redirigiendo a Mercado Pago…');
        toastOk('Pago iniciado. Redirigiendo…');

        setTimeout(() => { window.location.href = data.init_point; }, 350);
      }catch(e){
        const msg = (e && e.message) ? e.message : 'Error de conexión';
        setModalStatus('err', msg);
        toastErr('No se pudo iniciar el pago.');
      }
    }

    // Comprar (delegación)
    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('button.__btn__buy');
      if (!btn) return;

      const months = Number(btn.getAttribute('data-buy') || 0);
      const card = btn.closest('.plan-card');
      const total = Number(card?.getAttribute('data-price') || 0);

      if (!months || !total) return;

      // bloquear botones
      document.querySelectorAll('button.__btn__buy').forEach(b => b.disabled = true);
      await createPayment(months, total);

      // si no redirige (error) re-habilita
      setTimeout(() => {
        document.querySelectorAll('button.__btn__buy').forEach(b => b.disabled = false);
      }, 900);
    });

    // Botón verificar (placeholder)
    document.querySelectorAll('.__btn__ping').forEach(b => b.addEventListener('click', () => {
      // Si después querés, acá llamamos a un endpoint tipo /api/access/status
      setPageStatus('warn', 'Verificación manual: si pagaste recién, esperá unos minutos y reintentá.');
    }));

    // (Opcional) auto-open modal cuando entrás a /acceso
    // accessModal.show();
  </script>
</body>
</html>
