<!DOCTYPE html>
<html lang="es-AR" translate="no" data-bs-theme="light">

<head>
  <base href="/" target="_blank">
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="google" content="notranslate">
  <link rel="shortcut icon" href="/static/img/favicon.svg" />
  <title>KING•VPN - Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <link rel="stylesheet" href="../static/css/styles.css">
  <link rel="stylesheet" href="../static/css/bootstrap.css">
  <link rel="stylesheet" href="../static/css/sidebar.css">
  <link rel="stylesheet" href="../static/css/header.css">
  <link href="//cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.css" rel="stylesheet" />

  <script src="../static/js/dark_light.js"></script>
  <script src="//code.jquery.com/jquery-2.1.0.min.js"></script>

  <meta name="csrf-token" content="<%= it.csrfToken %>">

  <style>
    :root {
      /* ✅ menos azul, más “dark premium” */
      --bg1: #07070B;
      --bg2: #0E0F16;

      --panel: #121420;
      --panel2: #0C0D12;

      --gold: #D7B46A;
      --gold2: #F3D18B;

      --accent: rgba(215, 180, 106, .9);
      --accent2: rgba(243, 209, 139, .9);

      --line: rgba(215, 180, 106, .18);

      --text: #F2F3F7;
      --muted: rgba(242, 243, 247, .65);

      --radius: 18px;

      --shadow: 0 18px 55px rgba(0, 0, 0, .72);
      --softGlow: 0 0 0 1px rgba(215, 180, 106, .12), 0 14px 40px rgba(0, 0, 0, .64);
      --softGlow2: 0 0 0 1px rgba(243, 209, 139, .10), 0 18px 46px rgba(0, 0, 0, .72);
    }

    html,
    body {
      height: 100%;
    }

    body,
    body[data-bs-theme="light"],
    body[data-bs-theme="dark"] {
      min-height: 100vh !important;
      color: var(--text) !important;
      background:
        radial-gradient(900px 520px at 18% 12%, rgba(215, 180, 106, .12), transparent 62%),
        radial-gradient(900px 520px at 82% 14%, rgba(243, 209, 139, .08), transparent 60%),
        radial-gradient(900px 620px at 50% 92%, rgba(215, 180, 106, .08), transparent 62%),
        linear-gradient(135deg, var(--bg1), var(--bg2)) !important;
      background-attachment: fixed !important;
      overflow-x: hidden !important;
    }

    .container-fluid,
    main.d-flex {
      background: transparent !important;
    }

    main.d-flex {
      min-height: 100vh;
      justify-content: center;
    }

    .container-fluid {
      max-width: 1250px;
      width: 100%;
    }

    .content {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: calc(100vh - 80px);
      padding: 16px;
    }

    .dash-shell {
      width: 100%;
      max-width: 1120px;
      border-radius: calc(var(--radius) + 6px);
      background: linear-gradient(180deg, rgba(18, 20, 32, .92), rgba(12, 13, 18, .90));
      border: 1px solid rgba(215, 180, 106, .20);
      box-shadow: var(--shadow), 0 0 0 1px rgba(243, 209, 139, .04);
      backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
      padding: 16px;
    }

    .dash-shell::before {
      content: "";
      position: absolute;
      inset: -2px -2px auto -2px;
      height: 105px;
      background:
        radial-gradient(420px 105px at 18% 30%, rgba(215, 180, 106, .10), transparent 65%),
        radial-gradient(560px 105px at 70% 30%, rgba(243, 209, 139, .08), transparent 65%),
        linear-gradient(90deg, rgba(243, 209, 139, .06), rgba(215, 180, 106, .05));
      pointer-events: none;
      border-bottom: 1px solid rgba(215, 180, 106, .10);
    }

    .dash-title {
      position: relative;
      margin: 0 0 12px;
      font-size: 1.05rem;
      letter-spacing: .18em;
      text-transform: uppercase;
      color: rgba(242, 243, 247, .95);
      text-shadow: 0 0 18px rgba(243, 209, 139, .06);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .dash-title .left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .dash-title i {
      color: rgba(243, 209, 139, .95);
    }

    /* ✅ grilla de tu include */
    .dash-grid {
      position: relative;
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    /* ==========================
       ✅ Acceso / Compra (Home)
       ========================== */
    .access-box {
      margin: 8px 0 14px;
      display: flex;
      gap: 14px;
      padding: 14px;
      border-radius: 20px;
      border: 1px solid rgba(215, 180, 106, .18);
      background:
        radial-gradient(520px 140px at 18% 20%, rgba(243, 209, 139, .08), transparent 65%),
        radial-gradient(520px 140px at 78% 30%, rgba(215, 180, 106, .10), transparent 65%),
        linear-gradient(180deg, rgba(10, 11, 16, .94), rgba(16, 18, 26, .92));
      box-shadow: var(--softGlow2);
    }

    @media (max-width: 900px) {
      .access-box {
        flex-direction: column;
      }
    }

    .access-left {
      flex: 1;
      min-width: 280px;
    }

    .access-right {
      width: 320px;
      min-width: 280px;
    }

    .access-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(215, 180, 106, .22);
      background: rgba(18, 20, 32, .55);
      color: rgba(242, 243, 247, .96);
      font-weight: 900;
      letter-spacing: .10em;
      text-transform: uppercase;
      font-size: .72rem;
    }

    .access-badge.ok {
      border-color: rgba(243, 209, 139, .22);
    }

    .access-badge.danger {
      border-color: rgba(255, 99, 132, .22);
    }

    .access-title {
      margin-top: 10px;
      font-size: 1.25rem;
      font-weight: 950;
      letter-spacing: .02em;
      color: rgba(242, 243, 247, .98);
    }

    .access-sub {
      margin-top: 6px;
      color: rgba(242, 243, 247, .68);
    }

    .access-meta {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .meta-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 14px;
      border: 1px solid rgba(215, 180, 106, .12);
      background: rgba(12, 13, 18, .52);
      color: rgba(242, 243, 247, .88);
    }

    .meta-item i {
      color: rgba(243, 209, 139, .92);
    }

    .price-card {
      border-radius: 18px;
      border: 1px solid rgba(215, 180, 106, .22);
      background: rgba(18, 20, 32, .62);
      box-shadow: var(--softGlow);
      padding: 14px;
      backdrop-filter: blur(10px);
    }

    .price-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .price-name {
      font-weight: 950;
      letter-spacing: .10em;
      text-transform: uppercase;
      font-size: .78rem;
      color: rgba(242, 243, 247, .70);
    }

    .price-tag {
      font-size: .72rem;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(243, 209, 139, .18);
      color: rgba(243, 209, 139, .95);
      background: rgba(243, 209, 139, .06);
      font-weight: 700;
    }

    .price-value {
      margin-top: 10px;
      font-size: 2rem;
      font-weight: 950;
      letter-spacing: .02em;
      color: rgba(242, 243, 247, .98);
      text-shadow: 0 0 18px rgba(243, 209, 139, .12);
    }

    .price-note {
      margin-top: 4px;
      color: rgba(242, 243, 247, .62);
      font-size: .9rem;
    }

    .btn-buy,
    .btn-renew {
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 900;
      letter-spacing: .06em;
      text-transform: uppercase;
    }

    .btn-buy.btn-primary {
      background: linear-gradient(180deg, rgba(243, 209, 139, .95), rgba(215, 180, 106, .95));
      border: none;
      color: #0B0C10;
    }

    .btn-buy.btn-primary:hover {
      filter: brightness(1.03);
    }

    .tiny {
      color: rgba(242, 243, 247, .60);
      font-size: .82rem;
    }

    /* ✅ link */
    a,
    .btn-link {
      color: rgba(243, 209, 139, .92) !important;
    }
  </style>
</head>

<body>
  <script src="//cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.js"></script>

  <main class="d-flex">
    <%~ include("./sidebar", it) %>

    <div class="container-fluid p-0">
      <%~ include("./header", it) %>

      <div class="content pt-1 overflow-auto">
        <div class="dash-shell">
          <div class="dash-title">
            <div class="left">
              <i class="bi bi-speedometer2"></i> Panel
            </div>
          </div>

          <!-- ✅ BLOQUE ACCESO / COMPRA -->
          <div id="accessBox" class="access-box d-none">
            <div class="access-left">
              <div class="access-badge" id="accessBadge">
                <i class="bi bi-shield-lock-fill"></i>
                <span id="accessBadgeText">Acceso</span>
              </div>

              <div class="access-title" id="accessTitle">Tu acceso está vencido</div>
              <div class="access-sub" id="accessSub">
                Para seguir usando KING•VPN necesitás activar el acceso mensual.
              </div>

              <div class="access-meta">
                <div class="meta-item">
                  <i class="bi bi-calendar2-check"></i>
                  <span>Vence:</span>
                  <strong id="accessEnds">—</strong>
                </div>
                <div class="meta-item">
                  <i class="bi bi-clock-history"></i>
                  <span>Gracia:</span>
                  <strong id="graceEnds">—</strong>
                </div>
              </div>
            </div>

            <div class="access-right">
              <div class="price-card">
                <div class="price-top">
                  <div class="price-name">Acceso mensual</div>
                  <div class="price-tag">30 días</div>
                </div>

                <div class="price-value">$ <span id="priceArs">7.000</span></div>
                <div class="price-note">Pago con Mercado Pago</div>

                <button id="btnBuy" class="btn btn-primary w-100 btn-buy">
                  <i class="bi bi-bag-check-fill me-2"></i> Comprar acceso
                </button>

                <button id="btnRenew" class="btn btn-outline-light w-100 mt-2 btn-renew d-none">
                  <i class="bi bi-arrow-repeat me-2"></i> Renovar acceso
                </button>

                <div class="tiny mt-2" id="buyHint">
                  Te redirigimos a Mercado Pago para pagar seguro.
                </div>
              </div>
            </div>
          </div>

          <!-- ✅ Tu dashboard (cards) -->
          <div id="dashGrid" class="dash-grid">
            <%~ include("./cards", it) %>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="../static/js/sidebar.js"></script>
  <script src="../static/js/utils.js"></script>

  <script>
    // ✅ Datos del usuario desde el render (no expone password)
    window.__USER__ = {
      id: "<%= it.user?.id || '' %>",
      username: "<%= it.user?.username || '' %>",
      access_status: "<%= it.user?.access_status || 'NONE' %>",
      trial_ends_at: "<%= it.user?.trial_ends_at || '' %>",
      access_ends_at: "<%= it.user?.access_ends_at || '' %>",
      grace_delete_at: "<%= it.user?.grace_delete_at || '' %>",
    };
  </script>

  <script>
    const padStart = (value, length, pad) => `${value}`.padStart(length, pad);
    const setInternalError = (element) => element.innerHTML = '<span class="text-danger">Error interno</span>';

    const fetchDataAndUpdate = async () => {
      const config = document.querySelector('.__config');
      const configPlaceholder = document.querySelector('.__config__placeholder');

      const category = document.querySelector('.__category');
      const categoryPlaceholder = document.querySelector('.__category__placeholder');

      try {
        const data = await fetch('/config_count', { headers: {} });
        const response = await data.json();

        if (response.message) {
          if (config) config.textContent = padStart(0, 2, '0');
          if (category) category.textContent = padStart(0, 2, '0');
          return;
        }

        if (config) config.textContent = padStart(response.total_configs, 2, '');
        if (category) category.textContent = padStart(response.total_categories, 2, '');

      } catch (err) {
        if (config) setInternalError(config);
        if (category) setInternalError(category);
      } finally {
        if (configPlaceholder) configPlaceholder.classList.add('d-none');
        if (categoryPlaceholder) categoryPlaceholder.classList.add('d-none');
      }
    };

    fetchDataAndUpdate();
  </script>

  <script>
    // =========================================================
    // ✅ Acceso + Compra
    // =========================================================
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    const toNiceDate = (v) => {
      if (!v) return '—';
      try {
        const d = new Date(v);
        if (isNaN(d.getTime())) return v;
        return d.toLocaleString('es-AR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
      } catch {
        return v;
      }
    };

    const isPast = (v) => {
      if (!v) return false;
      const d = new Date(v);
      if (isNaN(d.getTime())) return false;
      return d.getTime() < Date.now();
    };

    const shouldPay = (u) => {
      const st = (u.access_status || 'NONE').toUpperCase();

      if (st === 'ACTIVE') return false;
      if (st === 'TRIAL' && u.trial_ends_at && isPast(u.trial_ends_at)) return true;
      if (st === 'GRACE') return true;
      if (st === 'NONE' || st === 'BLOCKED') return true;
      if (u.access_ends_at && isPast(u.access_ends_at)) return true;

      return false;
    };

    const setAccessUI = () => {
      const u = window.__USER__ || {};
      const box = document.getElementById('accessBox');
      const badge = document.getElementById('accessBadge');
      const badgeText = document.getElementById('accessBadgeText');
      const title = document.getElementById('accessTitle');
      const sub = document.getElementById('accessSub');
      const accessEnds = document.getElementById('accessEnds');
      const graceEnds = document.getElementById('graceEnds');
      const btnBuy = document.getElementById('btnBuy');
      const btnRenew = document.getElementById('btnRenew');

      if (!box) return;

      const pay = shouldPay(u);
      const queryPay = new URLSearchParams(window.location.search).get('pay');

      // mostramos el bloque si necesita pagar o si lo forzamos por ?pay=1
      if (!pay && queryPay !== '1') return;

      box.classList.remove('d-none');

      accessEnds.textContent = toNiceDate(u.access_ends_at || u.trial_ends_at || '');
      graceEnds.textContent = toNiceDate(u.grace_delete_at || '');

      const st = (u.access_status || 'NONE').toUpperCase();

      if (st === 'ACTIVE') {
        badge.classList.add('ok');
        badgeText.textContent = 'ACTIVO';
        title.textContent = 'Tu acceso está activo';
        sub.textContent = 'Podés usar el panel normalmente.';
        btnBuy.classList.add('d-none');
        btnRenew.classList.remove('d-none');
        return;
      }

      badge.classList.add('danger');
      badgeText.textContent = (st === 'TRIAL') ? 'DEMO VENCIDO' : 'ACCESO VENCIDO';

      if (st === 'GRACE') {
        title.textContent = 'Tu acceso venció (modo gracia)';
        sub.textContent = 'No podés usar el panel. Renová ahora para evitar que se borren tus datos.';
      } else if (st === 'TRIAL') {
        title.textContent = 'Tu demo terminó';
        sub.textContent = 'Activá el acceso mensual para seguir usando el servicio sin cortes.';
      } else {
        title.textContent = 'Necesitás activar el acceso';
        sub.textContent = 'Comprá el acceso mensual para habilitar el panel.';
      }

      const goPay = async () => {
        try {
          const res = await fetch('/api/mp/pay', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-csrf-token': csrfToken
            },
            body: JSON.stringify({ plan_code: 'plan_1m' })
          });

          const data = await res.json().catch(() => ({}));
          if (!res.ok || !data || data.ok === false) {
            throw new Error(data?.error || data?.message || 'Error creando el pago');
          }

          if (data.init_point) {
            window.location.href = data.init_point;
            return;
          }

          throw new Error('No se recibió init_point');
        } catch (e) {
          Swal.fire({
            icon: 'error',
            title: 'No se pudo iniciar el pago',
            text: (e && e.message) ? e.message : 'Error inesperado',
            confirmButtonText: 'OK'
          });
        }
      };

      btnBuy.addEventListener('click', goPay);
      btnRenew.addEventListener('click', goPay);

      if (queryPay === '1' || pay) {
        Swal.fire({
          icon: 'warning',
          title: 'Acceso requerido',
          html: `
            <div style="color:rgba(242,243,247,.75); line-height:1.35;">
              Para seguir usando <b>KING•VPN</b> necesitás activar el acceso mensual.<br/>
              <span style="display:block; margin-top:8px; font-size:.95rem;">
                Plan: <b>30 días</b> — <b>$7.000</b>
              </span>
            </div>
          `,
          showCancelButton: true,
          confirmButtonText: 'Comprar ahora',
          cancelButtonText: 'Más tarde',
          allowOutsideClick: true
        }).then((r) => {
          if (r.isConfirmed) goPay();
        });
      }
    };

    window.addEventListener('DOMContentLoaded', () => {
      setAccessUI();
    });
  </script>

  <script>
    /* =========================================================
       ✅ Enmarcado automático de métricas (SIN "Fecha de vencimiento")
       - Esto era lo que te estaba poniendo el texto arriba.
       - Ahora NO se toca vencimiento, solo totals + registro/actualización.
       ========================================================= */
    const wrapInFrame = (valueEl, titleText, iconClass = "bi bi-info-circle") => {
      if (!valueEl) return;
      if (valueEl.classList && valueEl.classList.contains('metric-value') && valueEl.closest('.metric-frame')) return;

      const host =
        valueEl.closest('.card') ||
        valueEl.closest('.col') ||
        valueEl.closest('[class*="col-"]') ||
        valueEl.closest('.p-3') ||
        valueEl.parentElement;

      if (!host || host.closest('.metric-frame')) return;

      const frame = document.createElement('div');
      frame.className = 'metric-frame';

      const title = document.createElement('div');
      title.className = 'metric-title';
      title.innerHTML = `<i class="${iconClass}"></i> ${titleText}`;

      host.parentNode.insertBefore(frame, host);
      frame.appendChild(title);
      frame.appendChild(host);

      try { valueEl.classList.add('metric-value'); } catch { }
    };

    const findByTextNear = (keywords) => {
      const all = Array.from(document.querySelectorAll('#dashGrid *'))
        .filter(n => n.childElementCount === 0 && (n.textContent || '').trim().length);

      const hit = all.find(n => {
        const t = (n.textContent || '').toLowerCase();
        return keywords.some(k => t.includes(k));
      });

      if (!hit) return null;

      const parent = hit.parentElement;
      if (!parent) return hit;

      const candidate =
        parent.querySelector('span, strong, h1, h2, h3, h4, h5, div') ||
        hit.nextElementSibling ||
        parent.nextElementSibling;

      return candidate || hit;
    };

    const frameDashboardMetrics = () => {
      // Totales (ok)
      wrapInFrame(document.querySelector('.__config'), 'Total de configuraciones', 'bi bi-gear-fill');
      wrapInFrame(document.querySelector('.__category'), 'Total de categorías', 'bi bi-grid-fill');

      // ❌ IMPORTANTE: NO tocamos VENCIMIENTO para que no aparezca “Fecha de vencimiento” arriba
      // const expire = ...
      // wrapInFrame(expire, 'Fecha de vencimiento', ...);

      // Registro / actualización (mejor esfuerzo)
      const reg =
        document.querySelector('#register, #registro, #created, #create_at, .__register, .__created') ||
        findByTextNear(['registrado', 'registro', 'registr', 'cread', 'created']);
      wrapInFrame(reg, 'Registrado el', 'bi bi-calendar2-plus-fill');

      const upd =
        document.querySelector('#update, #updated, #actualizacion, #actualización, #atualizacao, .__updated, .__update') ||
        findByTextNear(['actualiz', 'actualización', 'atualiz', 'update', 'updated']);
      wrapInFrame(upd, 'Actualizado el', 'bi bi-arrow-repeat');
    };

    window.addEventListener('DOMContentLoaded', () => {
      frameDashboardMetrics();
      const grid = document.getElementById('dashGrid') || document.body;
      new MutationObserver(() => frameDashboardMetrics())
        .observe(grid, { childList: true, subtree: true });

      let tries = 0;
      const t = setInterval(() => {
        frameDashboardMetrics();
        tries++;
        if (tries >= 12) clearInterval(t);
      }, 250);
    });
  </script>

</body>
</html>

