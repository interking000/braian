<!DOCTYPE html>
<html lang="es" translate="no" data-bs-theme="light">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="google" content="notranslate">
  <link rel="shortcut icon" href="/static/img/favicon.svg" />

  <title>KING•VPN</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <link href="//cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.css" rel="stylesheet" />

  <link rel="stylesheet" href="/static/css/styles.css">
  <link rel="stylesheet" href="/static/css/bootstrap.css">
  <link rel="stylesheet" href="/static/css/sidebar.css">
  <link rel="stylesheet" href="/static/css/header.css">
  <link rel="stylesheet" href="/static/css/app_config_custom.css">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror-one-dark-theme@1.1.1/one-dark.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/hint/show-hint.min.css">

  <meta name="csrf-token" content="<%= it.csrfToken %>">

  <style>
    #app_config_status, #app_config_status * { display:none !important; }
  </style>

  <!-- ✅ UI PRO página (igual) -->
  <style>
    :root{
      --kv-bg0:#060a11;
      --kv-bg1:#0a1420;
      --kv-text:rgba(238,243,255,.95);
      --kv-muted:rgba(238,243,255,.66);
      --kv-gold:rgba(255,211,77,.80);
      --kv-cyan:rgba(34,211,238,.80);
      --kv-shadow2:0 12px 35px rgba(0,0,0,.40);

      --fx-blue:#3bb2ff;
      --fx-cyan:#22d3ee;
      --fx-rose:#ff4fd8;
      --fx-red:#ff2b4a;
      --fx-white:#eef3ff;
      --fx-border:rgba(255,255,255,.10);
      --fx-glow: 0 0 30px rgba(59,178,255,.22), 0 0 40px rgba(255,79,216,.18), 0 0 50px rgba(255,43,74,.10);
    }

    body{
      background:
        radial-gradient(900px 520px at 12% 0%, rgba(255,211,77,.10), transparent 62%),
        radial-gradient(900px 520px at 92% 10%, rgba(34,211,238,.08), transparent 60%),
        linear-gradient(180deg, var(--kv-bg0), var(--kv-bg1)) !important;
      color: var(--kv-text);
    }

    .kv-page{ padding: 12px 10px 18px; }
    .kv-card{
      background: rgba(10,16,28,.30) !important;
      border: 1px solid rgba(255,255,255,.06) !important;
      box-shadow: var(--kv-shadow2);
      border-radius: 18px !important;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }

    .kv-titlebar{ display:flex; align-items:center; gap:10px; padding:14px 14px 10px; margin:0 0 10px; }
    .kv-title-icon{
      width:40px;height:40px;border-radius:14px;display:flex;align-items:center;justify-content:center;
      background:
        radial-gradient(16px 16px at 28% 30%, rgba(255,211,77,.26), transparent 65%),
        radial-gradient(16px 16px at 70% 70%, rgba(34,211,238,.18), transparent 65%),
        rgba(10,16,28,.55);
      border:1px solid rgba(255,211,77,.16);
      box-shadow:0 0 0 1px rgba(34,211,238,.08), 0 12px 28px rgba(0,0,0,.35);
    }
    .kv-title-icon i{ color: var(--kv-gold); font-size: 1.1rem; }
    .kv-title{ font-weight:950; letter-spacing:.10em; text-transform:uppercase; margin:0; font-size:1.05rem; color: rgba(238,243,255,.96); }
    .kv-subtitle{ margin:2px 0 0; font-size:.88rem; color: var(--kv-muted); letter-spacing:.04em; }

    .kv-actions{
      background:
        radial-gradient(750px 260px at 10% 0%, rgba(255,211,77,.08), transparent 62%),
        radial-gradient(750px 260px at 90% 10%, rgba(34,211,238,.06), transparent 60%),
        rgba(8,12,20,.55);
      border:1px solid rgba(255,255,255,.06);
      border-radius:16px; padding:10px;
      box-shadow:0 10px 28px rgba(0,0,0,.30);
    }

    .kv-btn{
      display:flex; align-items:center; justify-content:center; gap:8px; width:100%;
      border-radius:999px !important;
      padding:.52rem .90rem !important;
      font-weight:900 !important;
      letter-spacing:.12em !important;
      text-transform:uppercase;
      color: rgba(238,243,255,.95) !important;
      border:1px solid rgba(255,211,77,.14) !important;
      background:
        radial-gradient(140px 80px at 20% 30%, rgba(255,211,77,.16), transparent 60%),
        radial-gradient(140px 80px at 80% 30%, rgba(34,211,238,.10), transparent 60%),
        linear-gradient(135deg, rgba(7,10,18,.70), rgba(10,16,28,.92)) !important;
      box-shadow:0 0 0 1px rgba(255,211,77,.06), 0 14px 30px rgba(0,0,0,.42) !important;
      transition: transform .14s ease, filter .14s ease, box-shadow .14s ease;
      cursor: pointer;
    }
    .kv-btn i{ opacity:.95; font-size:1.05rem; }
    .kv-btn:hover{ transform: translateY(-1px); box-shadow: 0 0 0 1px rgba(34,211,238,.10), 0 18px 40px rgba(0,0,0,.50) !important; filter: brightness(1.05); }
    .kv-btn:active{ transform: translateY(0px); filter: brightness(.98); }
    .kv-btn:disabled{ opacity:.55; cursor:not-allowed !important; transform:none !important; box-shadow:none !important; pointer-events:none !important; }

    .kv-btn-primary{
      border:1px solid rgba(34,211,238,.16) !important;
      background:
        radial-gradient(160px 90px at 20% 30%, rgba(34,211,238,.16), transparent 60%),
        radial-gradient(160px 90px at 80% 30%, rgba(255,211,77,.14), transparent 60%),
        linear-gradient(135deg, rgba(7,10,18,.66), rgba(10,16,28,.96)) !important;
    }

    .content{ background: transparent !important; }
    .card.h-100.border-0.overflow-auto{ background: transparent !important; }
  </style>

  <!-- ✅ MODALES (los mismos del mensaje anterior, sin tocar lógica) -->
  <style>
    .modal-backdrop.show{ opacity:.78; }

    /* FORM */
    #apkFormModal .modal-content{
      background:
        radial-gradient(900px 420px at 8% 0%, rgba(255,79,216,.10), transparent 60%),
        radial-gradient(900px 420px at 92% 10%, rgba(59,178,255,.12), transparent 60%),
        linear-gradient(180deg, rgba(8,10,18,.96), rgba(8,10,18,.90)) !important;
      color: #eef3ff;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 35px 120px rgba(0,0,0,.75);
      overflow: hidden;
      backdrop-filter: blur(12px);
    }
    #apkFormModal .kv-badge{
      width: 42px; height: 42px; border-radius: 16px;
      display:flex; align-items:center; justify-content:center;
      background:
        radial-gradient(18px 18px at 30% 30%, rgba(59,178,255,.30), transparent 60%),
        radial-gradient(18px 18px at 70% 60%, rgba(255,79,216,.26), transparent 60%),
        rgba(12,14,26,.70);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--fx-glow);
    }
    #apkFormModal .kv-badge i{ color: #eef3ff; font-size: 1.15rem; }
    #apkFormModal .kv-title{
      font-weight: 999; letter-spacing: .14em; text-transform: uppercase;
      font-size: .95rem !important;
    }
    #apkFormModal .kv-sub{ color: rgba(238,243,255,.72); letter-spacing: .06em; }
    #apkFormModal .btn-close{ filter: invert(1) brightness(1.2); opacity:.9; }

    #apkFormModal .form-control{
      background: rgba(8,10,18,.65) !important;
      color: rgba(238,243,255,.95) !important;
      border: 1px solid rgba(255,255,255,.12) !important;
      border-radius: 14px !important;
    }
    #apkFormModal .form-control:focus{
      box-shadow: 0 0 0 3px rgba(59,178,255,.18) !important;
      border-color: rgba(59,178,255,.35) !important;
    }

    #apkFormModal .kv-grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 520px){ #apkFormModal .kv-grid{ grid-template-columns:1fr; } }

    #apkFormModal .kv-logo-preview{
      display:flex; align-items:center; gap:10px;
      padding: 10px;
      border-radius: 16px;
      border: 1px dashed rgba(255,255,255,.16);
      background: rgba(8,10,18,.45);
    }
    #apkFormModal .kv-logo-bubble{
      width: 56px; height: 56px;
      flex:0 0 56px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(7,10,18,.85);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
      box-shadow: var(--fx-glow);
    }
    #apkFormModal .kv-logo-bubble img{ width:100%; height:100%; object-fit:cover; object-position:center; display:none; }
    #apkFormModal .kv-logo-bubble i{ color: rgba(255,255,255,.95); font-size: 1.1rem; }

    #apkFormModal .kv-logo-meta .t1{ font-weight: 950; letter-spacing: .08em; font-size: .80rem; text-transform: uppercase; }
    #apkFormModal .kv-logo-meta .t2{
      font-size: .85rem;
      color: rgba(238,243,255,.72);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 260px;
    }

    #apkFormModal .kv-btn-cancel{
      background: rgba(255,255,255,.06) !important;
      border: 1px solid rgba(255,255,255,.14) !important;
      border-radius: 999px !important;
      color: rgba(238,243,255,.92) !important;
      font-weight: 950 !important;
      letter-spacing: .10em;
      padding: .60rem 1.1rem;
    }

    #apkFormModal .kv-btn-generate{
      background:
        radial-gradient(120px 70px at 20% 30%, rgba(255,79,216,.22), transparent 62%),
        radial-gradient(140px 70px at 75% 30%, rgba(59,178,255,.20), transparent 65%),
        linear-gradient(135deg, rgba(10,10,24,.82), rgba(11,16,32,.94)) !important;
      border: 1px solid rgba(255,255,255,.18) !important;
      border-radius: 999px !important;
      color: rgba(238,243,255,.96) !important;
      font-weight: 999 !important;
      letter-spacing: .14em;
      padding: .60rem 1.2rem;
      box-shadow: var(--fx-glow) !important;
    }
    #apkFormModal .kv-btn-generate:disabled{ opacity:.65; cursor:not-allowed; box-shadow:none !important; }

    /* PROGRESS */
    #apkProgressModal{ z-index: 20000; }
    #apkProgressModal .modal-dialog{ max-width: 520px; }
    #apkProgressModal .modal-content{
      background:
        radial-gradient(900px 420px at 10% 0%, rgba(255,43,74,.16), transparent 62%),
        radial-gradient(900px 420px at 90% 10%, rgba(255,79,216,.14), transparent 60%),
        radial-gradient(900px 420px at 60% 90%, rgba(59,178,255,.14), transparent 60%),
        linear-gradient(180deg, rgba(7,8,16,.97), rgba(7,8,16,.92)) !important;
      color: #eef3ff;
      border-radius: 26px;
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 60px 160px rgba(0,0,0,.85);
      overflow:hidden;
      backdrop-filter: blur(14px);
      position: relative;
    }
    #apkProgressModal .modal-content::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        linear-gradient(90deg, transparent, rgba(255,79,216,.35), transparent),
        linear-gradient(180deg, transparent, rgba(59,178,255,.25), transparent);
      opacity:.18;
      pointer-events:none;
      transform: rotate(6deg);
    }
    .fx-head{
      display:flex; align-items:center; justify-content:space-between;
      padding: 16px 16px 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .fx-brand{ display:flex; align-items:center; gap:10px; }
    .fx-chip{
      width: 46px; height: 46px; border-radius: 18px;
      display:flex; align-items:center; justify-content:center;
      background:
        radial-gradient(18px 18px at 30% 30%, rgba(255,43,74,.35), transparent 60%),
        radial-gradient(18px 18px at 70% 60%, rgba(59,178,255,.30), transparent 60%),
        rgba(12,14,26,.70);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: var(--fx-glow);
    }
    .fx-chip i{ font-size: 1.15rem; color: #eef3ff; }
    .fx-title{ margin:0; font-weight: 999; letter-spacing: .16em; text-transform: uppercase; font-size: .88rem; }
    .fx-sub{ margin:2px 0 0; color: rgba(238,243,255,.72); letter-spacing: .06em; font-size: .82rem; }
    .fx-body{ padding: 16px; }
    .fx-indicator{
      display:flex; align-items:center; gap:14px;
      padding: 14px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
    }
    .fx-ring{
      width: 86px; height: 86px; border-radius: 999px;
      position: relative;
      display:flex; align-items:center; justify-content:center;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,43,74,.22), transparent 55%),
        radial-gradient(circle at 70% 60%, rgba(59,178,255,.22), transparent 55%),
        rgba(10,10,18,.55);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: var(--fx-glow);
      overflow:hidden;
    }
    .fx-ring::before{
      content:"";
      position:absolute; inset:-22px;
      background: conic-gradient(
        from 180deg,
        rgba(59,178,255,.00),
        rgba(59,178,255,.45),
        rgba(255,79,216,.45),
        rgba(255,43,74,.45),
        rgba(59,178,255,.00)
      );
      animation: fxSpin 1.15s linear infinite;
      opacity:.9;
    }
    .fx-ring::after{
      content:"";
      position:absolute; inset:8px;
      background: rgba(7,8,16,.92);
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: inset 0 0 18px rgba(0,0,0,.55);
    }
    .fx-percent{
      position: relative;
      z-index: 2;
      font-weight: 999;
      font-size: 1.05rem;
      letter-spacing: .08em;
      color: rgba(238,243,255,.96);
      text-shadow: 0 0 12px rgba(59,178,255,.22);
    }
    @keyframes fxSpin{ to { transform: rotate(360deg); } }

    .fx-info{ flex:1; }
    .fx-status{ margin:0; font-weight: 950; letter-spacing: .08em; text-transform: uppercase; font-size: .85rem; }
    .fx-detail{ margin:4px 0 0; color: rgba(238,243,255,.72); font-size: .88rem; }

    .fx-bar{
      margin-top: 12px;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      overflow:hidden;
      box-shadow: inset 0 0 12px rgba(0,0,0,.45);
    }
    .fx-bar > div{
      height: 100%;
      width: 15%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(255,43,74,.95), rgba(255,79,216,.95), rgba(59,178,255,.95), rgba(238,243,255,.92));
      box-shadow: 0 0 22px rgba(59,178,255,.18);
      animation: fxLoad 1.05s ease-in-out infinite;
    }
    @keyframes fxLoad{
      0%   { transform: translateX(-20%); width: 18%; }
      50%  { transform: translateX(45%); width: 55%; }
      100% { transform: translateX(120%); width: 18%; }
    }

    /* DONE */
    #apkDoneModal{ z-index: 21000; }
    #apkDoneModal .modal-dialog{ max-width: 600px; }
    #apkDoneModal .modal-content{
      background:
        radial-gradient(900px 420px at 12% 0%, rgba(59,178,255,.16), transparent 60%),
        radial-gradient(900px 420px at 90% 10%, rgba(255,79,216,.14), transparent 60%),
        radial-gradient(900px 420px at 60% 90%, rgba(255,43,74,.12), transparent 60%),
        linear-gradient(180deg, rgba(7,8,16,.98), rgba(7,8,16,.94)) !important;
      color: #eef3ff;
      border-radius: 26px;
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: 0 60px 180px rgba(0,0,0,.90);
      overflow:hidden;
      backdrop-filter: blur(14px);
    }
    .done-top{
      padding: 16px 16px 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:space-between;
    }
    .done-brand{ display:flex; align-items:center; gap:12px; }
    .done-logo{
      width: 66px; height: 66px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.20);
      box-shadow: var(--fx-glow);
      overflow:hidden;
      display:flex; align-items:center; justify-content:center;
      flex:0 0 66px;
    }
    .done-logo img{ width:100%; height:100%; object-fit: cover; object-position:center; display:none; }
    .done-logo i{ font-size: 1.25rem; color: rgba(238,243,255,.92); }
    .done-title{
      margin:0; font-weight: 999; letter-spacing: .16em; text-transform: uppercase; font-size: .95rem;
    }
    .done-sub{ margin:2px 0 0; color: rgba(238,243,255,.72); letter-spacing: .06em; font-size: .86rem; }
    .done-hero{ padding: 14px 16px 0; }
    .done-hero h3{
      margin: 0; font-weight: 999; letter-spacing: .06em; line-height: 1.1; font-size: 1.15rem;
      text-shadow: 0 0 18px rgba(59,178,255,.16);
    }
    .done-hero .spark{
      background: linear-gradient(90deg, rgba(255,43,74,.95), rgba(255,79,216,.95), rgba(59,178,255,.95), rgba(238,243,255,.92));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    .done-hero p{ margin: 8px 0 0; color: rgba(238,243,255,.72); font-size: .92rem; }
    .done-body{ padding: 16px; }
    .done-card{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      border-radius: 18px;
      padding: 14px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
    }
    .done-row{
      display:flex; justify-content:space-between; gap:10px;
      padding: 10px 0;
      border-bottom: 1px dashed rgba(255,255,255,.10);
      flex-wrap: wrap;
    }
    .done-row:last-child{ border-bottom: none; padding-bottom: 0; }
    .done-k{
      color: rgba(238,243,255,.70);
      letter-spacing: .06em;
      font-size: .82rem;
      text-transform: uppercase;
      font-weight: 900;
    }
    .done-v{
      color: rgba(238,243,255,.94);
      font-size: .94rem;
      font-weight: 900;
      max-width: 380px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .done-badges{ display:flex; gap:8px; flex-wrap:wrap; margin-top: 12px; }
    .done-badge{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-weight: 900;
      letter-spacing: .10em;
      text-transform: uppercase;
      font-size: .72rem;
      color: rgba(238,243,255,.92);
    }
    .done-badge.blue{ border-color: rgba(59,178,255,.25); box-shadow: 0 0 20px rgba(59,178,255,.10); }
    .done-badge.rose{ border-color: rgba(255,79,216,.22); box-shadow: 0 0 20px rgba(255,79,216,.10); }
    .done-badge.red{ border-color: rgba(255,43,74,.22); box-shadow: 0 0 20px rgba(255,43,74,.10); }
    .done-footer{
      padding: 12px 16px 16px;
      border-top: 1px solid rgba(255,255,255,.10);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .done-btn{
      border-radius: 999px !important;
      font-weight: 999 !important;
      letter-spacing: .14em;
      text-transform: uppercase;
      padding: .62rem 1.15rem !important;
      border: 1px solid rgba(255,255,255,.16) !important;
      background: rgba(255,255,255,.06) !important;
      color: rgba(238,243,255,.95) !important;
    }
    .done-btn-primary{
      border: none !important;
      background: linear-gradient(90deg, rgba(255,43,74,.96), rgba(255,79,216,.96), rgba(59,178,255,.96), rgba(238,243,255,.92)) !important;
      color: #06101f !important;
      box-shadow: var(--fx-glow);
    }
  </style>
</head>

<body>
  <script src="//cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.js"></script>

  <main class="d-flex">
    <%~ include("./sidebar", it) %>

    <div class="container-fluid p-0">
      <%~ include("./header", it) %>

      <div class="content pt-1 overflow-auto">
        <div class="kv-page">

          <div class="card kv-card h-100 border-0 overflow-auto">
            <div class="card-body m-0">

              <div class="kv-titlebar">
                <div class="kv-title-icon">
                  <i class="bi bi-lightning-charge-fill"></i>
                </div>
                <div class="d-flex flex-column">
                  <h1 class="kv-title">TU APP Y TUS DISEÑOS.</h1>
                  <div class="kv-subtitle">KING•VPN • Diseños & APK • Panel de configuración</div>
                </div>
              </div>

              <div class="kv-actions mb-3">
                <div class="d-flex gap-2">
                  <button type="button" class="__create kv-btn flex-fill">
                    <i class="bi bi-plus-lg"></i>
                    <span>NUEVO</span>
                  </button>

                  <button type="button" class="__import kv-btn flex-fill">
                    <i class="bi bi-file-earmark-arrow-up"></i>
                    <span>IMPORTAR</span>
                  </button>
                </div>

                <div class="mt-2">
                  <!-- ✅ FIX: NO dejarlo permanently disabled -->
                  <button type="button" id="btnOpenApk" class="export-config kv-btn kv-btn-primary w-100">
                    <i class="bi bi-android"></i>
                    <span>GENERAR APK</span>
                  </button>
                </div>
              </div>

              <div class="col-md-2 mb-2" style="display:none !important;">
                <select class="form-select" id="app_config_status">
                  <option value="ACTIVE">ACTIVO</option>
                  <option value="INACTIVE">INACTIVO</option>
                  <option value="ALL" selected>TODOS</option>
                </select>
              </div>

              <div class="row m-auto mb-3 center-column" id="app"></div>

              <div class="d-flex justify-content-center align-items-center mt-5" id="loading">
                <div class="spinner-border p-5" role="status">
                  <span class="sr-only"></span>
                </div>
              </div>

            </div>
          </div>

        </div>
      </div>
    </div>
  </main>

  <!-- ✅ MODAL A: FORM -->
  <div class="modal fade" id="apkFormModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-md">
      <div class="modal-content">
        <div class="modal-header border-0">
          <div class="d-flex align-items-center gap-2">
            <div class="kv-badge">
              <i class="bi bi-android2"></i>
            </div>
            <div class="d-flex flex-column">
              <h5 class="modal-title kv-title m-0">Generar APK</h5>
              <small class="kv-sub">Configurá el nombre, paquete y logo</small>
            </div>
          </div>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>

        <div class="modal-body">
          <div class="kv-grid mb-2">
            <div>
              <label class="form-label mb-1">Nombre de la app</label>
              <input class="form-control" id="appName" placeholder="Ej: KING VPN" value="KING VPN">
            </div>
            <div>
              <label class="form-label mb-1">Nombre del paquete</label>
              <input class="form-control" id="packageName" placeholder="Ej: com.kingvpn.app">
            </div>
          </div>

          <div class="kv-grid mb-2">
            <div>
              <label class="form-label mb-1">URL del logo</label>
              <input class="form-control" id="logoUrl" placeholder="https://.../logo.png">
            </div>
            <div>
              <label class="form-label mb-1">Logo (cualquier imagen)</label>
              <input class="form-control" id="logoFile" type="file" accept="image/*">
            </div>
          </div>

          <div class="kv-logo-preview mb-2">
            <div class="kv-logo-bubble" id="logoBubble">
              <i class="bi bi-image"></i>
              <img id="logoImg" alt="Logo preview">
            </div>
            <div class="kv-logo-meta">
              <div class="t1">Preview</div>
              <div class="t2" id="logoHint">Elegí un archivo o poné una URL</div>
            </div>
          </div>

          <p class="text-center" style="margin:0;color:rgba(238,243,255,.72)">
            Cuando estés listo, tocá <b>Generar</b>.
          </p>
        </div>

        <div class="modal-footer border-0 d-flex justify-content-between">
          <button type="button" class="btn kv-btn-cancel" data-bs-dismiss="modal">
            <i class="bi bi-x-lg"></i> Cancelar
          </button>
          <button type="button" class="btn kv-btn-generate" id="btnGenerateApp">
            <i class="bi bi-gear-fill"></i> Generar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ MODAL B: PROGRESS -->
  <div class="modal fade" id="apkProgressModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="fx-head">
          <div class="fx-brand">
            <div class="fx-chip"><i class="bi bi-cpu-fill"></i></div>
            <div class="d-flex flex-column">
              <h6 class="fx-title" id="fxTitle">Generando APK</h6>
              <div class="fx-sub" id="fxSub">Inicializando proceso…</div>
            </div>
          </div>
          <button type="button" class="btn-close btn-close-white" id="fxCloseX" style="opacity:.85" aria-label="Cerrar"></button>
        </div>

        <div class="fx-body">
          <div class="fx-indicator">
            <div class="fx-ring">
              <div class="fx-percent" id="fxPercent">0%</div>
            </div>
            <div class="fx-info">
              <p class="fx-status" id="fxStatus">EN PROCESO</p>
              <p class="fx-detail" id="fxDetail">Estamos compilando, firmando y armando tu APK.</p>
              <div class="fx-bar"><div></div></div>
            </div>
          </div>
        </div>

        <div class="px-3 pb-3" style="color:rgba(238,243,255,.70);font-size:.88rem;">
          No cierres esta ventana mientras se genera.
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ MODAL C: DONE -->
  <div class="modal fade" id="apkDoneModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">

        <div class="done-top">
          <div class="done-brand">
            <div class="done-logo" id="doneLogoBox">
              <i class="bi bi-shield-check"></i>
              <img id="doneLogoImg" alt="Logo final">
            </div>
            <div>
              <h6 class="done-title m-0">APK Lista</h6>
              <div class="done-sub" id="doneSubtitle">Compilación completada con éxito</div>
            </div>
          </div>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>

        <div class="done-hero">
          <h3 id="doneCongrats">
            <span class="spark">Felicidades</span>, tu app ha sido creada con éxito ✅
          </h3>
          <p>
            Todo quedó aplicado con tus diseños y configuraciones. Descargá tu APK cuando quieras.
          </p>
        </div>

        <div class="done-body">
          <div class="done-card">
            <div class="done-row">
              <div class="done-k">Usuario</div>
              <div class="done-v" id="doneUser">-</div>
            </div>
            <div class="done-row">
              <div class="done-k">Nombre de la app</div>
              <div class="done-v" id="doneAppName">-</div>
            </div>
            <div class="done-row">
              <div class="done-k">Paquete</div>
              <div class="done-v" id="donePackage">-</div>
            </div>
            <div class="done-row">
              <div class="done-k">Logo</div>
              <div class="done-v" id="doneLogoInfo">-</div>
            </div>
            <div class="done-row">
              <div class="done-k">Diseños</div>
              <div class="done-v" id="doneDesigns">Aplicados (tema + layout + colores) ✅</div>
            </div>

            <div class="done-badges">
              <div class="done-badge blue"><i class="bi bi-lightning-charge"></i> build</div>
              <div class="done-badge rose"><i class="bi bi-palette2"></i> diseños</div>
              <div class="done-badge red"><i class="bi bi-shield-lock"></i> firma</div>
            </div>
          </div>
        </div>

        <div class="done-footer">
          <button type="button" class="btn done-btn" data-bs-dismiss="modal">
            <i class="bi bi-check2"></i> Listo
          </button>

          <button type="button" class="btn done-btn-primary" id="doneDownloadBtn">
            <i class="bi bi-download"></i> Descargar APK
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- libs -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script src="/static/js/sidebar.js"></script>
  <script src="/static/js/utils.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/css/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/htmlmixed/htmlmixed.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/hint/show-hint.min.js"></script>

  <script src="/static/js/jscolor.js"></script>
  <script src="/static/js/dark_light.js"></script>

  <!-- ✅ Creds + Usuario -->
  <script>
    window.__APK_CREDS__ = {
      user_id: "<%= it.user.id %>",
      token: "<%= it.user.id %>"
    };

    window.__USER__ = {
      display_name: "<%= (it.user && (it.user.name || it.user.username || it.user.email)) || it.user.id %>"
    };
  </script>

  <!-- ✅ JS: bind del botón + modales (FIX incluido) -->
  <script>
    (function () {
      let csrfToken = (typeof getCsrfTokenHead === "function") ? getCsrfTokenHead() : null;

      function toastErr(msg){
        if (typeof showToastError === "function") return showToastError(msg);
        try { toastr.error(msg); } catch {}
      }
      function toastOk(msg){
        if (typeof showToastSuccess === "function") return showToastSuccess(msg);
        try { toastr.success(msg); } catch {}
      }

      const formEl = document.getElementById("apkFormModal");
      const progressEl = document.getElementById("apkProgressModal");
      const doneEl = document.getElementById("apkDoneModal");

      const formModal = new bootstrap.Modal(formEl);
      const progressModal = new bootstrap.Modal(progressEl);
      const doneModal = new bootstrap.Modal(doneEl);

      const btnOpenById = document.getElementById("btnOpenApk");
      const btnOpenByClass = document.querySelector(".export-config");

      const btnGenerate = document.getElementById("btnGenerateApp");

      const appNameEl = document.getElementById("appName");
      const packageNameEl = document.getElementById("packageName");
      const logoUrlEl = document.getElementById("logoUrl");
      const logoFileEl = document.getElementById("logoFile");

      const logoImg = document.getElementById("logoImg");
      const logoHint = document.getElementById("logoHint");
      const logoBubble = document.getElementById("logoBubble");
      const logoIcon = logoBubble ? logoBubble.querySelector("i") : null;

      const fxSub = document.getElementById("fxSub");
      const fxPercent = document.getElementById("fxPercent");
      const fxDetail = document.getElementById("fxDetail");
      const fxCloseX = document.getElementById("fxCloseX");

      const doneLogoBox = document.getElementById("doneLogoBox");
      const doneLogoImg = document.getElementById("doneLogoImg");
      const doneSubtitle = document.getElementById("doneSubtitle");
      const doneCongrats = document.getElementById("doneCongrats");
      const doneUser = document.getElementById("doneUser");
      const doneAppName = document.getElementById("doneAppName");
      const donePackage = document.getElementById("donePackage");
      const doneLogoInfo = document.getElementById("doneLogoInfo");
      const doneDownloadBtn = document.getElementById("doneDownloadBtn");

      let logoBase64 = null;
      let logoFilename = null;
      let logoMime = null;
      let apkUrl = null;
      let lastFormData = null;

      function enableOpenButton(){
        const btn = btnOpenById || btnOpenByClass;
        if (!btn) return;
        btn.removeAttribute("disabled");
        btn.style.pointerEvents = "auto";
      }

      function bindOpenButton(){
        const btn = btnOpenById || btnOpenByClass;
        if (!btn) return;

        // evitar doble bind
        if (btn.dataset.bound === "1") return;
        btn.dataset.bound = "1";

        btn.addEventListener("click", (ev) => {
          ev.preventDefault();
          enableOpenButton();
          resetLogo();
          formModal.show();
        });
      }

      function resetLogo(){
        logoBase64 = null;
        logoFilename = null;
        logoMime = null;
        if (logoImg) logoImg.style.display = "none";
        if (logoIcon) logoIcon.style.display = "inline-block";
        if (logoHint) logoHint.textContent = "Elegí un archivo o poné una URL";
        if (logoFileEl) logoFileEl.value = "";
      }

      // ✅ FIX: asegurar habilitar y bindear siempre
      enableOpenButton();
      bindOpenButton();
      document.addEventListener("DOMContentLoaded", () => {
        enableOpenButton();
        bindOpenButton();
      });

      // preview por URL
      if (logoUrlEl){
        logoUrlEl.addEventListener("input", () => {
          const url = (logoUrlEl.value || "").trim();
          if (!url) return;
          if (!logoBase64){
            logoImg.src = url;
            logoImg.style.display = "block";
            if (logoIcon) logoIcon.style.display = "none";
            logoHint.textContent = url;
          }
        });
      }

      // ✅ aceptar cualquier imagen
      if (logoFileEl){
        logoFileEl.addEventListener("change", () => {
          const file = logoFileEl.files && logoFileEl.files[0];
          if (!file) return;

          if (!file.type || !file.type.startsWith("image/")){
            toastErr("El logo debe ser una imagen (JPG/PNG/WEBP/etc).");
            logoFileEl.value = "";
            return;
          }

          logoFilename = file.name;
          logoMime = file.type;

          const reader = new FileReader();
          reader.onload = () => {
            logoBase64 = reader.result;
            logoImg.src = logoBase64;
            logoImg.style.display = "block";
            if (logoIcon) logoIcon.style.display = "none";
            logoHint.textContent = file.name;
          };
          reader.readAsDataURL(file);
        });
      }

      // progress steps
      const steps = [
        { sub: "Validando datos…", detail: "Chequeando nombre, paquete y logo." },
        { sub: "Compilando y firmando…", detail: "Construyendo la app y aplicando firma." },
        { sub: "Aplicando tus diseños…", detail: "Tema, layout y recursos visuales." },
        { sub: "Finalizando…", detail: "Preparando la descarga." }
      ];
      let stepTimer = null;
      let pctTimer = null;

      function startProgressUX(){
        fxSub.textContent = steps[0].sub;
        fxDetail.textContent = steps[0].detail;
        fxPercent.textContent = "0%";

        let i = 0;
        clearInterval(stepTimer);
        stepTimer = setInterval(() => {
          i = (i + 1) % steps.length;
          fxSub.textContent = steps[i].sub;
          fxDetail.textContent = steps[i].detail;
        }, 1400);

        let p = 0;
        clearInterval(pctTimer);
        pctTimer = setInterval(() => {
          p += Math.floor(Math.random()*7) + 2;
          if (p >= 92) p = 92;
          fxPercent.textContent = p + "%";
        }, 520);
      }

      function stopProgressUX(){
        clearInterval(stepTimer);
        clearInterval(pctTimer);
        stepTimer = null;
        pctTimer = null;
      }

      fxCloseX.addEventListener("click", () => { /* bloqueado */ });

      async function readResponseUrl(response){
        const ct = (response.headers.get("content-type") || "").toLowerCase();
        if (ct.includes("application/json")){
          const data = await response.json();
          return data.url || data.apkUrl || data.path || null;
        }
        return (await response.text()).trim();
      }

      function escapeHtml(str){
        return String(str).replace(/[&<>"']/g, s => ({
          "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
        }[s]));
      }

      function fillDoneModal({ appName, packageName, logoUrl, usedFile }){
        const user = (window.__USER__ && window.__USER__.display_name) ? window.__USER__.display_name : "Usuario";

        doneCongrats.innerHTML = `<span class="spark">Felicidades ${escapeHtml(user)}</span>, tu app ha sido creada con éxito ✅`;
        doneUser.textContent = user;

        doneAppName.textContent = appName || "-";
        donePackage.textContent = packageName || "-";

        const info = usedFile ? `Archivo: ${usedFile}` : (logoUrl ? `URL: ${logoUrl}` : "Sin logo");
        doneLogoInfo.textContent = info;

        const urlToPreview = logoBase64 || (logoUrl ? logoUrl : null);
        if (urlToPreview){
          doneLogoImg.src = urlToPreview;
          doneLogoImg.style.display = "block";
          const icon = doneLogoBox.querySelector("i");
          if (icon) icon.style.display = "none";
        } else {
          doneLogoImg.style.display = "none";
          const icon = doneLogoBox.querySelector("i");
          if (icon) icon.style.display = "inline-block";
        }

        doneSubtitle.textContent = "Tu APK ya está lista para descargar";
      }

      doneDownloadBtn.addEventListener("click", () => {
        if (!apkUrl) return;
        window.location.href = apkUrl;
        doneModal.hide();
      });

      btnGenerate.addEventListener("click", async () => {
        const appName = (appNameEl.value || "").trim() || "KING VPN";
        const packageName = (packageNameEl.value || "").trim() || null;
        const logo_url = (logoUrlEl.value || "").trim() || null;

        const creds = window.__APK_CREDS__ || {};
        const user_id = (creds.user_id || "").toString().trim();
        const token = (creds.token || "").toString().trim();

        if (!user_id){ toastErr("Faltan credenciales (user_id)."); return; }
        if (!token){ toastErr("Faltan credenciales (token)."); return; }

        lastFormData = { appName, packageName, logoUrl: logo_url, usedFile: logoFilename || null };

        const payload = {
          user_id,
          token,
          appName,
          packageName,
          logo_url,
          logo_base64: logoBase64 || null,
          logo_filename: logoFilename || null,
          logo_mime: logoMime || null
        };

        formModal.hide();
        progressModal.show();
        startProgressUX();

        try{
          const response = await fetch("/download-app", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              ...(csrfToken ? { "csrf-token": csrfToken } : {})
            },
            body: JSON.stringify(payload)
          });

          if (typeof getCsrfTokenRefresh === "function"){
            const refreshed = getCsrfTokenRefresh(response);
            if (refreshed) csrfToken = refreshed;
          }

          if (!response.ok) throw new Error("Error generando APK");

          apkUrl = await readResponseUrl(response);
          if (!apkUrl) throw new Error("URL inválida");

          stopProgressUX();
          fxPercent.textContent = "100%";
          progressModal.hide();

          fillDoneModal(lastFormData);
          doneModal.show();
          toastOk("APK lista ✅");

        } catch(e){
          stopProgressUX();
          progressModal.hide();
          toastErr("Error al generar la app.");
          formModal.show();
        }
      });

      formEl.addEventListener("hidden.bs.modal", () => {
        if (logoFileEl) logoFileEl.value = "";
      });
      progressEl.addEventListener("hidden.bs.modal", () => stopProgressUX());
    })();
  </script>

  <!-- ✅ main.js (tu versión parchada) -->
  <script type="module" src="/static/js/app_config/main.js"></script>
</body>
</html>
