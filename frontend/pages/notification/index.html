<!DOCTYPE html>
<html lang="es-AR" translate="no" data-bs-theme="dark">
<head>
  <base href="/" target="_self">
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="google" content="notranslate">
  <link rel="shortcut icon" href="../static/img/favicon.svg" />
  <title>DTunnelMod - Notificaciones</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="csrf-token" content="<%= it.csrfToken %>">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.css" />

  <link rel="stylesheet" href="../static/css/styles.css">
  <link rel="stylesheet" href="../static/css/bootstrap.css">
  <link rel="stylesheet" href="../static/css/sidebar.css">
  <link rel="stylesheet" href="../static/css/header.css">

  <script src="../static/js/dark_light.js"></script>
  <script src="//code.jquery.com/jquery-2.1.0.min.js"></script>

  <style>
    :root{
      --bg1:#070A10;
      --bg2:#0B1020;

      --accent:#8B5CF6;
      --accent2:#22D3EE;
      --accent3:#A78BFA;

      --line: rgba(167,139,250,.18);

      --text:#EAF0FF;
      --muted:#AAB3D6;

      --radius:18px;

      --shadow: 0 18px 55px rgba(0,0,0,.65);
      --ring: 0 0 0 3px rgba(139,92,246,.18);
      --softGlow: 0 0 0 1px rgba(167,139,250,.12), 0 12px 28px rgba(0,0,0,.55);
      --softGlow2: 0 0 0 1px rgba(34,211,238,.12), 0 18px 40px rgba(0,0,0,.62);
    }

    html, body{ height:100%; }
    body,
    body[data-bs-theme="light"],
    body[data-bs-theme="dark"]{
      min-height:100vh !important;
      color:var(--text) !important;
      background:
        radial-gradient(950px 520px at 18% 12%, rgba(139,92,246,.18), transparent 62%),
        radial-gradient(900px 520px at 82% 14%, rgba(34,211,238,.14), transparent 60%),
        radial-gradient(900px 620px at 50% 92%, rgba(167,139,250,.10), transparent 62%),
        linear-gradient(135deg, var(--bg1), var(--bg2)) !important;
      background-attachment: fixed !important;
      overflow-x:hidden;
    }
    .container-fluid, main.d-flex{ background: transparent !important; }
    main.d-flex{ min-height:100vh; justify-content:center; }
    .container-fluid{ max-width: 1250px; width: 100%; }

    .content{
      display:flex; justify-content:center; align-items:center;
      min-height: calc(100vh - 80px);
      padding: 16px;
    }

    .content > .card{
      width:100%;
      max-width:1120px;
      max-height: calc(100vh - 120px);
      border-radius: calc(var(--radius) + 6px);
      background: linear-gradient(180deg, rgba(14,20,36,.92), rgba(11,16,32,.88));
      border: 1px solid rgba(167,139,250,.18) !important;
      box-shadow: var(--shadow), 0 0 0 1px rgba(34,211,238,.05);
      backdrop-filter: blur(10px);
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }
    .card-body{ padding: 18px; }

    .text-gray-800{
      color: var(--text) !important;
      letter-spacing: .14em;
      text-transform: uppercase;
      font-weight: 900;
    }
    .mini-label{
      display:block;
      font-size:.75rem;
      letter-spacing:.14em;
      text-transform: uppercase;
      color: rgba(170,179,214,.92);
      margin: 0 0 6px;
    }

    .btn{
      border-radius: 14px !important;
      border: 1px solid rgba(167,139,250,.16) !important;
      color: var(--text) !important;
      background: rgba(7,10,18,.70) !important;
      box-shadow: 0 0 0 1px rgba(34,211,238,.04), 0 10px 18px rgba(0,0,0,.40);
      transition: transform .08s ease, box-shadow .2s ease, filter .2s ease;
      font-weight: 800;
      letter-spacing:.06em;
      text-transform: uppercase;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: var(--softGlow2); filter: brightness(1.03); }
    .btn:active{ transform: translateY(0px); }

    .btn-danger-ish{
      border-color: rgba(255,77,77,.25) !important;
    }
    .btn-danger-ish i{ color: #ff4d4d; }

    /* ✅ Grid 4×4 (responsive) */
    .grid-wrap{
      border-radius: 18px;
      border: 1px solid rgba(167,139,250,.16);
      background: rgba(0,0,0,.55);
      box-shadow: inset 0 0 0 1px rgba(34,211,238,.04);
      padding: 12px;
    }
    .notif-grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
    }
    @media (max-width: 1100px){ .notif-grid{ grid-template-columns: repeat(3, minmax(0, 1fr)); } }
    @media (max-width: 820px){ .notif-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (max-width: 420px){ .notif-grid{ grid-template-columns: 1fr; } }

    .notif-card{
      border-radius: 16px;
      background: rgba(0,0,0,.86);
      border: 1px solid rgba(167,139,250,.18);
      box-shadow: 0 0 0 1px rgba(34,211,238,.05), 0 16px 28px rgba(0,0,0,.55);
      overflow:hidden;
      position: relative;
    }
    .notif-head{
      padding: 10px 12px;
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 10px;
      background:
        radial-gradient(260px 60px at 20% 30%, rgba(34,211,238,.10), transparent 62%),
        radial-gradient(320px 60px at 70% 30%, rgba(139,92,246,.14), transparent 65%),
        rgba(0,0,0,.55);
      border-bottom: 1px solid rgba(167,139,250,.12);
    }
    .notif-title{
      font-weight: 950;
      font-size: .95rem;
      letter-spacing:.02em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }
    .notif-sub{
      color: rgba(170,179,214,.92);
      font-weight: 750;
      font-size: .82rem;
      margin-top: 3px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .notif-body{
      padding: 12px;
      background: rgba(0,0,0,.55);
    }
    .notif-msg{
      color: rgba(234,240,255,.92);
      font-size: .88rem;
      line-height: 1.25rem;
      min-height: 2.5rem;
    }
    .notif-meta{
      margin-top: 10px;
      color: rgba(170,179,214,.82);
      font-size: .78rem;
      display:flex;
      flex-direction: column;
      gap: 4px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 5px 9px;
      border-radius: 999px;
      border: 1px solid rgba(167,139,250,.18);
      background: rgba(0,0,0,.55);
      box-shadow: inset 0 0 0 1px rgba(34,211,238,.04);
      font-size: .70rem;
      letter-spacing:.12em;
      text-transform: uppercase;
      white-space: nowrap;
      width: fit-content;
    }
    .pill.on{ border-color: rgba(34,211,238,.30); box-shadow: var(--softGlow2); }

    .notif-actions{
      padding: 10px 12px;
      border-top: 1px solid rgba(167,139,250,.12);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      background: rgba(0,0,0,.55);
    }
    .act-left{ display:flex; align-items:center; gap:10px; }
    .act-right{ display:flex; align-items:center; gap:8px; }
    .icon-btn{
      width: 42px;
      height: 36px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:0;
      border-radius: 12px;
      background: rgba(0,0,0,.72);
      border: 1px solid rgba(167,139,250,.16);
      box-shadow: 0 0 0 1px rgba(34,211,238,.04), 0 10px 18px rgba(0,0,0,.55);
      color: var(--text);
      text-decoration:none;
    }
    .icon-btn i{ font-size: 1.02rem; color: rgba(34,211,238,.90); }
    .icon-btn:hover{ filter: brightness(1.05); transform: translateY(-1px); }

    /* ✅ checkbox bonito */
    .chk{
      width: 18px; height: 18px;
      accent-color: #22D3EE;
      transform: translateY(2px);
    }

    /* ===========================
       ✅ MODALES PRO (igual a categorías)
       =========================== */
    @keyframes popIn {
      from { transform: translateY(10px) scale(.98); opacity: 0; }
      to   { transform: translateY(0) scale(1); opacity: 1; }
    }
    .modal.show .modal-dialog{ animation: popIn .18s ease-out; }

    .modal .modal-dialog{
      margin: 140px auto 1.25rem !important;
      max-width: 720px;
    }
    @media (max-width: 540px){
      .modal .modal-dialog{ margin-top: 120px !important; max-width: calc(100vw - 18px); }
    }

    .modal-content,
    .swal2-popup{
      background: rgba(0,0,0,.90) !important;
      color: var(--text) !important;
      border-radius: 18px !important;
      border: 1px solid rgba(167,139,250,.18) !important;
      box-shadow: var(--shadow), 0 0 0 1px rgba(34,211,238,.06) !important;
      backdrop-filter: blur(14px);
      overflow: hidden;
    }
    .modal-header, .modal-footer{
      border-color: rgba(167,139,250,.12) !important;
      background:
        linear-gradient(90deg, rgba(34,211,238,.12), rgba(0,0,0,.92), rgba(139,92,246,.14)) !important;
    }
    .modal-title{
      letter-spacing:.14em;
      text-transform: uppercase;
      font-weight: 950;
    }
    .btn-close{ filter: invert(1) brightness(1.15); opacity: .85; }
    .btn-close:hover{ opacity: 1; }

    .modal input, .modal select, .modal textarea{
      background: rgba(7,10,18,.86) !important;
      color: var(--text) !important;
      border: 1px solid rgba(167,139,250,.18) !important;
      border-radius: 12px !important;
      padding: .48rem .7rem !important;
      min-height: 40px;
      font-size: .92rem;
    }
    .modal label{
      font-size: .82rem;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: rgba(170,179,214,.92);
      font-weight: 900;
      margin-bottom: 6px;
    }

    .modal-footer .btn{
      border-radius: 14px !important;
      font-weight: 950 !important;
      letter-spacing:.10em !important;
      text-transform: uppercase !important;
      padding: .62rem 1rem !important;
      border: 1px solid rgba(34,211,238,.18) !important;
      color: var(--text) !important;
      background:
        radial-gradient(120px 60px at 20% 30%, rgba(34,211,238,.16), transparent 62%),
        radial-gradient(160px 60px at 70% 30%, rgba(139,92,246,.22), transparent 65%),
        linear-gradient(135deg, rgba(0,0,0,.92), rgba(7,10,18,.80)) !important;
      box-shadow: var(--softGlow2) !important;
    }

    /* ✅ Sidebar SIEMPRE arriba del modal */
    .sidebar{ z-index: 2005 !important; }
    .modal-backdrop{ z-index: 2000 !important; }
    .modal{ z-index: 2001 !important; }

    /* ✅ mini helper */
    .muted{ color: rgba(170,179,214,.82); }
    .tiny{ font-size: .86rem; }
  </style>
</head>

<body>
  <script src="//cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.js"></script>

  <main class="d-flex">
    <%~ include("./sidebar", it) %>
    <div class="container-fluid p-0">
      <%~ include("./header", it) %>

      <div class="content pt-1 overflow-auto">
        <div class="card h-100 border border-0 shadow overflow-auto">
          <div class="card-body m-0">

            <div class="d-flex align-items-start justify-content-between gap-3 flex-wrap">
              <div>
                <h1 class="mt-2 h3 mb-2 text-gray-800">NOTIFICACIONES</h1>
                <div class="muted tiny">
                  Creá, guardá y reenviá avisos. La APK las lee por consulta (polling).
                </div>
              </div>

              <div class="d-flex align-items-center gap-2">
                <button type="button" class="btn __btn__create">
                  <i class="bi bi-plus-lg"></i> CREAR
                </button>
                <button type="button" class="btn btn-danger-ish __btn__delete">
                  <i class="bi bi-trash3"></i> ELIMINAR
                </button>
                <button type="button" class="btn __btn__reload">
                  <i class="bi bi-arrow-repeat"></i> RECARGAR
                </button>
              </div>
            </div>

            <div class="mt-3 grid-wrap">
              <div class="d-flex align-items-center justify-content-between mb-2 gap-2 flex-wrap">
                <div class="muted tiny" id="countHint">—</div>
                <div class="muted tiny" id="selHint">0 seleccionadas</div>
              </div>

              <div id="grid" class="notif-grid"></div>
              <div id="empty" class="muted tiny" style="display:none; padding:10px;">
                Todavía no hay notificaciones guardadas.
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- ===========================
       MODAL CREAR / EDITAR
       =========================== -->
  <div class="modal fade" id="notifModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header border-0">
          <h5 class="modal-title"><i class="bi bi-bell-fill"></i> NOTIFICACIÓN</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" id="notif_id" value="">

          <div class="row g-3">
            <div class="col-md-6">
              <label>Título</label>
              <input id="title" class="form-control" maxlength="80" placeholder="MANTENIMIENTO">
            </div>
            <div class="col-md-6">
              <label>Subtítulo (opcional)</label>
              <input id="subtitle" class="form-control" maxlength="140" placeholder="Servidor en mejoras">
            </div>

            <div class="col-12">
              <label>Mensaje</label>
              <textarea id="message" class="form-control" rows="5" placeholder="Escribí el aviso..."></textarea>
            </div>

            <div class="col-md-6">
              <label>Enlace (opcional)</label>
              <input id="link" class="form-control" placeholder="https://...  o  /downloads/app.apk">
              <div class="muted tiny mt-1">Podés poner links de archivos (APK) o URLs.</div>
            </div>

            <div class="col-md-6">
              <label>Imagen (URL opcional)</label>
              <input id="image" class="form-control" placeholder="https://.../imagen.png">
            </div>

            <div class="col-md-6">
              <label>Programar envío (opcional)</label>
              <input id="scheduled_at" type="datetime-local" class="form-control">
            </div>

            <div class="col-md-6">
              <label>Estado</label>
              <select id="status" class="form-control">
                <option value="ACTIVE">ACTIVE</option>
                <option value="DISABLED">DISABLED</option>
              </select>
            </div>
          </div>
        </div>

        <div class="modal-footer border-0 d-flex justify-content-between">
          <button type="button" class="btn" data-bs-dismiss="modal">
            <i class="bi bi-x-lg"></i> CERRAR
          </button>
          <button type="button" class="btn __btn__save">
            <i class="bi bi-send"></i> GUARDAR
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="../static/js/sidebar.js"></script>
  <script src="../static/js/utils.js"></script>

  <script>
    // =========================
    // CONFIG
    // =========================
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || '';

    // ✅ TUS RUTAS REALES (según grep)
    const API = {
      list:   '/app_notifications/list',
      create: '/app_notifications/create',
      update: (id) => '/app_notifications/update/' + id,
      del:    (id) => '/app_notifications/delete/' + id,
    };

    const $ = (id) => document.getElementById(id);

    // Modal
    const notifModalEl = $('notifModal');
    const notifModal = new bootstrap.Modal(notifModalEl);

    // Cache
    let NOTIFS = [];
    let SELECTED = new Set();

    // =========================
    // HELPERS UI
    // =========================
    const toastOk = (m) => (window.showToastSuccess ? showToastSuccess(m) : toastr.success(m));
    const toastErr = (m) => (window.showToastError ? showToastError(m) : toastr.error(m));

    const escapeHtml = (s) => String(s ?? '').replace(/[&<>"']/g, (m) => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
    }[m]));

    const shorten = (s, n) => {
      const t = String(s ?? '');
      if (t.length <= n) return t;
      return t.slice(0, n - 1) + '…';
    };

    const fmt = (iso) => {
      if (!iso) return '';
      try { return new Date(iso).toLocaleString(); } catch { return String(iso); }
    };

    function setCount() {
      $('countHint').textContent = `${NOTIFS.length} guardadas`;
      $('selHint').textContent = `${SELECTED.size} seleccionadas`;
    }

    function clearModalForm() {
      $('notif_id').value = '';
      $('title').value = '';
      $('subtitle').value = '';
      $('message').value = '';
      $('link').value = '';
      $('image').value = '';
      $('scheduled_at').value = '';
      $('status').value = 'ACTIVE';
    }

    function isoFromDatetimeLocal(val) {
      if (!val) return null;
      const d = new Date(val);
      if (Number.isNaN(d.getTime())) return null;
      return d.toISOString();
    }

    function datetimeLocalFromIso(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return '';
      const pad = (x) => String(x).padStart(2, '0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    // =========================
    // RENDER GRID
    // =========================
    function renderGrid() {
      const grid = $('grid');
      const empty = $('empty');

      if (!NOTIFS.length) {
        grid.innerHTML = '';
        empty.style.display = 'block';
        setCount();
        return;
      }
      empty.style.display = 'none';

      grid.innerHTML = NOTIFS.map(n => {
        const checked = SELECTED.has(n.id) ? 'checked' : '';
        const pillOn = (n.status || 'ACTIVE') === 'ACTIVE' ? 'pill on' : 'pill';
        const scheduled = n.scheduled_at ? `Programada: ${fmt(n.scheduled_at)}` : 'Sin programación';

        return `
          <div class="notif-card" data-id="${n.id}">
            <div class="notif-head">
              <div style="min-width:0">
                <div class="notif-title">${escapeHtml(n.title || '—')}</div>
                ${n.subtitle ? `<div class="notif-sub">${escapeHtml(n.subtitle)}</div>` : ``}
              </div>
              <label class="d-flex align-items-center gap-2" style="user-select:none;">
                <input class="chk __sel" type="checkbox" data-id="${n.id}" ${checked}>
              </label>
            </div>

            <div class="notif-body">
              <div class="notif-msg">${escapeHtml(shorten(n.message || '', 180))}</div>

              <div class="notif-meta">
                <span class="${pillOn}"><i class="bi bi-activity"></i> ${escapeHtml(n.status || 'ACTIVE')}</span>
                <span class="pill"><i class="bi bi-clock"></i> ${escapeHtml(scheduled)}</span>
                <span class="pill"><i class="bi bi-calendar2"></i> ${escapeHtml(fmt(n.created_at) || '')}</span>
                ${n.link ? `<span class="pill"><i class="bi bi-link-45deg"></i> LINK</span>` : ``}
                ${n.image ? `<span class="pill"><i class="bi bi-image"></i> IMG</span>` : ``}
              </div>
            </div>

            <div class="notif-actions">
              <div class="act-left">
                <button class="icon-btn __edit" type="button" title="Editar" data-id="${n.id}">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="icon-btn __resend" type="button" title="Reenviar (duplica)" data-id="${n.id}">
                  <i class="bi bi-arrow-repeat"></i>
                </button>
              </div>

              <div class="act-right">
                ${n.link ? `<a class="icon-btn" href="${escapeHtml(n.link)}" target="_blank" rel="noopener" title="Abrir link"><i class="bi bi-box-arrow-up-right"></i></a>` : ``}
              </div>
            </div>
          </div>
        `;
      }).join('');

      setCount();
    }

    // =========================
    // API CALLS
    // =========================
    async function apiJson(url, opts = {}) {
      const res = await fetch(url, opts);
      const ct = (res.headers.get('content-type') || '').toLowerCase();
      const data = ct.includes('application/json') ? await res.json().catch(() => null) : await res.text().catch(() => null);
      return { ok: res.ok, status: res.status, data };
    }

    async function loadList() {
      const grid = $('grid');
      grid.innerHTML = `<div class="muted tiny" style="padding:10px;">Cargando...</div>`;
      $('empty').style.display = 'none';

      const r = await apiJson(API.list, { method:'GET' });
      if (!r.ok) {
        console.error('list error', r);
        grid.innerHTML = `<div class="text-danger tiny" style="padding:10px;">Error cargando lista (${r.status}).</div>`;
        NOTIFS = [];
        SELECTED.clear();
        setCount();
        return;
      }

      // ✅ tu list-notifications normalmente devuelve { result: [...] }
      const rows =
        Array.isArray(r.data) ? r.data :
        (r.data && Array.isArray(r.data.result)) ? r.data.result :
        (r.data && Array.isArray(r.data.data)) ? r.data.data :
        [];

      NOTIFS = rows.map(x => ({
        id: x.id,
        title: x.title,
        subtitle: x.subtitle,
        message: x.message,
        link: x.link,
        image: x.image,
        scheduled_at: x.scheduled_at,
        status: x.status || 'ACTIVE',
        created_at: x.created_at,
        updated_at: x.updated_at,
      }));

      // limpiar selección de ids que ya no existen
      const ids = new Set(NOTIFS.map(n => n.id));
      SELECTED = new Set([...SELECTED].filter(id => ids.has(id)));

      renderGrid();
    }

    async function createOrUpdate() {
      const id = String($('notif_id').value || '').trim();

      const title = String($('title').value || '').trim();
      const subtitle = String($('subtitle').value || '').trim();
      const message = String($('message').value || '').trim();
      const link = String($('link').value || '').trim();
      const image = String($('image').value || '').trim();
      const scheduledLocal = String($('scheduled_at').value || '').trim();
      const status = String($('status').value || 'ACTIVE').trim();

      if (!title) return toastErr('Título requerido');
      if (!message) return toastErr('Mensaje requerido');

      const payload = {
        title,
        subtitle: subtitle ? subtitle : null,
        message,
        link: link ? link : null,
        image: image ? image : null,
        scheduled_at: scheduledLocal ? isoFromDatetimeLocal(scheduledLocal) : null,
        status,
      };

      const url = id ? API.update(id) : API.create;
      const method = id ? 'PUT' : 'POST';

      const r = await apiJson(url, {
        method,
        headers: {
          'Content-Type':'application/json',
          'csrf-token': csrfToken,
        },
        body: JSON.stringify(payload),
      });

      if (!r.ok) {
        console.error('save error', r);
        return toastErr((r.data && r.data.message) ? r.data.message : 'Error guardando notificación');
      }

      toastOk(id ? 'Notificación actualizada' : 'Notificación creada');
      notifModal.hide();
      clearModalForm();
      await loadList();
    }

    async function resendDuplicate(id) {
      const n = NOTIFS.find(x => String(x.id) === String(id));
      if (!n) return;

      const payload = {
        title: n.title,
        subtitle: n.subtitle || null,
        message: n.message,
        link: n.link || null,
        image: n.image || null,
        scheduled_at: null,
        status: 'ACTIVE',
      };

      const r = await apiJson(API.create, {
        method: 'POST',
        headers: {
          'Content-Type':'application/json',
          'csrf-token': csrfToken,
        },
        body: JSON.stringify(payload),
      });

      if (!r.ok) {
        console.error('resend error', r);
        return toastErr('Error reenviando');
      }

      toastOk('Reenviado (se creó una nueva)');
      await loadList();
    }

    async function deleteSelected() {
      const ids = [...SELECTED];
      if (!ids.length) return toastErr('No seleccionaste nada');

      const conf = await Swal.fire({
        icon: 'warning',
        title: 'Eliminar',
        text: `Vas a eliminar ${ids.length} notificación(es).`,
        showCancelButton: true,
        confirmButtonText: 'Eliminar',
        cancelButtonText: 'Cancelar',
      });

      if (!conf.isConfirmed) return;

      for (const id of ids) {
        const r = await apiJson(API.del(id), {
          method: 'DELETE',
          headers: { 'csrf-token': csrfToken },
        });
        if (!r.ok) {
          console.error('delete error', id, r);
          toastErr('Error eliminando id ' + id);
          break;
        }
      }

      toastOk('Eliminadas');
      SELECTED.clear();
      await loadList();
    }

    // =========================
    // EVENTS
    // =========================
    document.querySelector('.__btn__create').addEventListener('click', () => {
      clearModalForm();
      notifModal.show();
    });

    document.querySelector('.__btn__delete').addEventListener('click', deleteSelected);
    document.querySelector('.__btn__reload').addEventListener('click', loadList);
    document.querySelector('.__btn__save').addEventListener('click', createOrUpdate);

    // Delegación grid (select, edit, resend)
    document.addEventListener('click', (e) => {
      const sel = e.target.closest('input.__sel');
      if (sel) {
        const id = Number(sel.getAttribute('data-id'));
        if (!Number.isFinite(id)) return;
        if (sel.checked) SELECTED.add(id); else SELECTED.delete(id);
        setCount();
        return;
      }

      const editBtn = e.target.closest('button.__edit');
      if (editBtn) {
        const id = editBtn.getAttribute('data-id');
        const n = NOTIFS.find(x => String(x.id) === String(id));
        if (!n) return;

        $('notif_id').value = String(n.id);
        $('title').value = n.title || '';
        $('subtitle').value = n.subtitle || '';
        $('message').value = n.message || '';
        $('link').value = n.link || '';
        $('image').value = n.image || '';
        $('scheduled_at').value = datetimeLocalFromIso(n.scheduled_at);
        $('status').value = n.status || 'ACTIVE';

        notifModal.show();
        return;
      }

      const resendBtn = e.target.closest('button.__resend');
      if (resendBtn) {
        const id = resendBtn.getAttribute('data-id');
        resendDuplicate(id);
        return;
      }
    });

    // ✅ Pull to refresh REAL sobre el contenedor que scrollea (la card)
    (function enablePullToRefresh(){
      const scroller = document.querySelector('.content > .card');
      if (!scroller) return;

      let startY = 0;
      let pulling = false;

      const start = (e) => {
        if (scroller.scrollTop > 0) return;
        startY = e.touches ? e.touches[0].clientY : e.clientY;
        pulling = true;
      };

      const move = (e) => {
        if (!pulling) return;
        if (scroller.scrollTop > 0) { pulling = false; return; }
        const y = e.touches ? e.touches[0].clientY : e.clientY;
        const dy = y - startY;
        if (dy > 120) {
          pulling = false;
          loadList();
        }
      };

      const end = () => pulling = false;

      scroller.addEventListener('touchstart', start, { passive:true });
      scroller.addEventListener('touchmove', move, { passive:true });
      scroller.addEventListener('touchend', end, { passive:true });
    })();

    // Init
    loadList();
  </script>
</body>
</html>