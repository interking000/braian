generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                 String   @id @default(uuid())
  username           String   @unique
  password           String
  email              String   @unique
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt

  // versiones app
  app_text_version   Int      @default(1)
  app_layout_version Int      @default(1)
  app_config_version Int      @default(1)

  // ===============================
  // ✅ Premium / Acceso al panel
  // ===============================
  access_status    String   @default("NONE") // NONE | TRIAL | ACTIVE | GRACE | BLOCKED
  trial_ends_at    DateTime?
  access_ends_at   DateTime?
  grace_delete_at  DateTime?
  last_payment_at  DateTime?

  // relaciones existentes
  cdn             Cdn[]
  AppText         AppText[]
  Category        Category[]
  AppConfig       AppConfig[]
  AppLayout       AppLayout[]
  AppNotification AppNotification[]

  // pagos
  payments      Payment[]
  access_events AccessEvent[]

  @@index([access_status])
  @@index([trial_ends_at])
  @@index([access_ends_at])
  @@index([grace_delete_at])
  @@index([last_payment_at])
  @@map("users")
}

model Cdn {
  id     String @id @default(cuid())
  name   String
  url    String
  status String

  user_id String
  user    User   @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@map("cdn")
}

model Category {
  id         Int      @id @default(autoincrement())
  name       String
  color      String
  sorter     Int
  status     String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user_id String
  user    User     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  Config  AppConfig[]

  @@index([user_id])
  @@map("categories")
}

model AppConfig {
  id                     Int      @id @default(autoincrement())
  auth_password          String?
  auth_username          String?
  auth_v2ray_uuid        String?
  category_id            Int
  config_openvpn         String?
  config_payload_payload String?
  config_payload_sni     String?
  config_v2ray           String?
  description            String?
  dns_server_dns1        String?
  dns_server_dns2        String?
  icon                   String
  mode                   String
  name                   String
  proxy_host             String?
  proxy_port             Int?
  server_host            String?
  server_port            Int?
  dnstt_key              String?
  dnstt_name_server      String?
  dnstt_server           String?
  hy_obfs                String?
  hy_insecure            Boolean?
  hy_port                String?
  hy_up_mbps             Int?
  hy_down_mbps           Int?
  hy_version             Int?
  sorter                 Int
  status                 String
  tls_version            String?
  udp_ports              String?
  created_at             DateTime @default(now())
  updated_at             DateTime @updatedAt
  url_check_user         String?

  user_id String
  user    User     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  category Category @relation(fields: [category_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([user_id])
  @@index([category_id])
  @@map("app_configs")
}

model AppText {
  id      Int    @id @default(autoincrement())
  label   String
  text    String

  user_id String
  user    User   @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([user_id])
  @@map("app_texts")
}

model AppLayout {
  id        Int     @id @default(autoincrement())
  user_id   String
  is_active Boolean @default(false)

  user           User               @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  layout_storage AppLayoutStorage[]

  @@index([user_id])
  @@index([is_active])
  @@map("app_layouts")
}

model AppLayoutStorage {
  id            Int     @id @default(autoincrement())
  label         String
  name          String
  status        String
  type          String
  value         String?

  app_layout_id Int
  app_layout    AppLayout @relation(fields: [app_layout_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([app_layout_id])
  @@index([type])
  @@map("app_layout_storages")
}

// ===============================
// ✅ Notificaciones (para tu endpoint dtunnelmod)
// ===============================
model AppNotification {
  id          Int      @id @default(autoincrement())
  user_id     String
  status      String   @default("ACTIVE") // ACTIVE | INACTIVE
  title       String?
  subtitle    String?
  message     String?
  link        String?
  image       String?
  scheduled_at DateTime?
  next_send_at DateTime?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([user_id])
  @@index([next_send_at])
  @@map("app_notifications")
}

// ===============================
// ✅ PLANES (3 planes)
// ===============================
model Plan {
  id          Int      @id @default(autoincrement())
  code        String   @unique   // "plan_1m" | "plan_3m" | "plan_5m"
  name        String
  months      Int
  price_ars   Int
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  payments Payment[]
  @@index([is_active])
  @@map("plans")
}

// ===============================
// ✅ PAGOS (Mercado Pago)
// ===============================
model Payment {
  id            Int      @id @default(autoincrement())
  user_id       String
  plan_id       Int?
  provider      String   @default("MERCADOPAGO") // MERCADOPAGO | MANUAL | OTHER
  status        String   @default("PENDING")     // PENDING | APPROVED | REJECTED | CANCELLED | REFUNDED | CHARGEDBACK
  amount        Int?
  currency      String?
  mp_payment_id String?  @unique
  mp_pref_id    String?
  external_ref  String?
  metadata      String?  // JSON string (por sqlite)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  user   User  @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  plan   Plan? @relation(fields: [plan_id], references: [id], onDelete: SetNull, onUpdate: Cascade)

  access_events AccessEvent[]

  @@index([user_id])
  @@index([plan_id])
  @@index([provider])
  @@index([status])
  @@index([created_at])
  @@map("payments")
}

// ===============================
// ✅ Eventos de acceso (auditoría)
// ===============================
model AccessEvent {
  id         Int      @id @default(autoincrement())
  user_id    String
  payment_id Int?
  type       String   // PAYMENT_APPROVED | PAYMENT_REJECTED | SUBSCRIPTION_EXTENDED | ADMIN_GRANT | etc
  message    String?
  created_at DateTime @default(now())

  user    User     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  payment Payment? @relation(fields: [payment_id], references: [id], onDelete: SetNull, onUpdate: Cascade)

  @@index([user_id])
  @@index([payment_id])
  @@index([type])
  @@index([created_at])
  @@map("access_events")
}
